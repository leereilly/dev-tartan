<!DOCTYPE html>
<!--

    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
    â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•  â•šâ•â•â•â•       â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â• â•šâ•â•â•â•

    Every developer deserves their own clan.
    SHA-256 â†’ Sett â†’ SVG â†’ ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  You're reading the source. Respect.                             â”‚
    â”‚                                                                  â”‚
    â”‚  Fun facts:                                                      â”‚
    â”‚  â€¢ There are 20 colours per palette Ã— 3 palettes = 60 hues       â”‚
    â”‚  â€¢ SHA-256 gives 2Â²âµâ¶ possible tartans (~1.16 Ã— 10â·â·)            â”‚
    â”‚  â€¢ That's more tartans than atoms in the observable universe     â”‚
    â”‚  â€¢ The bagpipe synth uses Web Audio API oscillators tuned to     â”‚
    â”‚    a pentatonic scale derived from your username hash            â”‚
    â”‚                                                                  â”‚
    â”‚  Built with GitHub Copilot CLI                                   â”‚
    â”‚  https://github.com/leereilly/dev-tartan                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dev Tartan â€” Generate a Unique Tartan from Your GitHub Username</title>
  <meta name="description" content="Turn your GitHub username into a unique, deterministic tartan pattern using SHA-256. 106 real clan tartans included. Download SVG, hear your bagpipe tune. Every developer deserves their own clan.">
  <meta name="keywords" content="GitHub, tartan, plaid, developer tools, GitHub username, SVG generator, Scottish tartan, clan tartan, open source, deterministic art, generative art">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#1c2541">
  <link rel="canonical" href="https://leereilly.net/dev-tartan">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="What's Your Developer Clan Tartan?">
  <meta property="og:description" content="Your GitHub username hides a unique tartan pattern. SHA-256 turns it into a deterministic plaid â€” with authentic colors, a downloadable SVG, and even a bagpipe tune. Find yours.">
  <meta property="og:url" content="https://leereilly.net/dev-tartan">
  <meta property="og:image" content="https://leereilly.net/dev-tartan/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="Dev Tartan â€” a unique tartan pattern generated from a GitHub username">
  <meta property="og:site_name" content="Dev Tartan">
  <meta property="og:locale" content="en_US">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="What's Your Developer Clan Tartan?">
  <meta name="twitter:description" content="Your GitHub username hides a unique tartan. SHA-256 â†’ plaid â†’ SVG â†’ ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿. Find yours.">
  <meta name="twitter:image" content="https://leereilly.net/dev-tartan/og-image.png">
  <meta name="twitter:image:alt" content="Dev Tartan â€” a unique tartan pattern generated from a GitHub username">
  <meta name="twitter:creator" content="@leereilly">
  <meta name="twitter:site" content="@leereilly">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Dev Tartan",
    "url": "https://leereilly.net/dev-tartan",
    "description": "Generate a unique, deterministic tartan pattern from any GitHub username using SHA-256 hashing. 106 real clan tartans included.",
    "applicationCategory": "DesignApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "author": { "@type": "Person", "name": "Lee Reilly", "url": "https://github.com/leereilly" },
    "image": "https://leereilly.net/dev-tartan/og-image.png",
    "screenshot": "https://leereilly.net/dev-tartan/demo.webp"
  }
  </script>

  <!-- Favicon: inline tartan-inspired SVG -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%231c2541'/%3E%3Crect x='0' y='6' width='32' height='4' fill='%238b1a1a' opacity='0.8'/%3E%3Crect x='0' y='22' width='32' height='4' fill='%238b1a1a' opacity='0.8'/%3E%3Crect x='6' y='0' width='4' height='32' fill='%231a472a' opacity='0.8'/%3E%3Crect x='22' y='0' width='4' height='32' fill='%231a472a' opacity='0.8'/%3E%3Crect x='14' y='0' width='2' height='32' fill='%23c5a041' opacity='0.6'/%3E%3Crect x='0' y='14' width='32' height='2' fill='%23c5a041' opacity='0.6'/%3E%3C/svg%3E">

  <!-- Fonts: GitHub's Mona Sans variable font -->
  <link rel="preload" href="https://cdn.jsdelivr.net/fontsource/fonts/mona-sans:vf@latest/latin-wght-normal.woff2" as="font" type="font/woff2" crossorigin>
  <style>
    @font-face {
      font-family: 'Mona Sans';
      font-style: normal;
      font-display: swap;
      font-weight: 200 900;
      src: url('https://cdn.jsdelivr.net/fontsource/fonts/mona-sans:vf@latest/latin-wght-normal.woff2') format('woff2-variations');
    }
  </style>


  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K6GL40J18G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    
    gtag('config', 'G-K6GL40J18G');
  </script>

  <style>

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background: #f4edd3;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(139,119,75,0.03) 50px, rgba(139,119,75,0.03) 51px),
        repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(139,119,75,0.03) 50px, rgba(139,119,75,0.03) 51px);
      font-family: 'Mona Sans', sans-serif;
      color: #2c1810;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    .invertocat-wrap {
      display: inline-block;
      width: 120px;
      height: 120px;
      margin-bottom: 0.75rem;
    }

    .invertocat-wrap svg {
      width: 100%;
      height: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-family: 'Mona Sans', sans-serif;
      font-size: 2.8rem;
      font-weight: 700;
      color: #1a0f08;
      letter-spacing: 0.04em;
      margin-bottom: 0.25rem;
    }

    header h1 a {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    header h1 a:hover {
      text-decoration: underline;
      text-decoration-color: #8b2500;
      text-underline-offset: 4px;
    }

    header h1 .accent {
      color: #8b2500;
    }

    header p.subtitle {
      font-size: 1.15rem;
      font-style: italic;
      color: #5a4232;
      margin-top: 0.25rem;
    }

    .header-nav {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 0.5rem;
    }

    .header-nav a {
      font-family: 'Mona Sans', sans-serif;
      font-size: 1rem;
      color: #6b5240;
      text-decoration: none;
      padding: 0.2rem 0;
      border-bottom: 1px solid transparent;
      transition: all 0.2s;
    }

    .header-nav a:hover {
      color: #8b2500;
      border-bottom-color: #8b2500;
    }

    .divider {
      width: 200px;
      height: 2px;
      background: linear-gradient(90deg, transparent, #8b774b, transparent);
      margin: 0.75rem auto;
    }

    .input-section {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .input-section label {
      font-family: 'Mona Sans', sans-serif;
      font-size: 1.1rem;
      color: #3d2b1f;
    }

    .input-section input[type="text"] {
      font-family: 'Mona Sans', sans-serif;
      font-size: 1.15rem;
      padding: 0.5rem 1rem;
      border: 2px solid #8b774b;
      border-radius: 4px;
      background: #faf6e9;
      color: #2c1810;
      width: 260px;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-section input[type="text"]:focus {
      border-color: #8b2500;
    }

    .input-section input[type="text"]::placeholder {
      color: #b5a78a;
      font-style: italic;
    }

    button {
      font-family: 'Mona Sans', sans-serif;
      font-size: 1rem;
      padding: 0.55rem 1.5rem;
      border: 2px solid #8b774b;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    button.generate-btn {
      background: #8b2500;
      color: #f4edd3;
      border-color: #6b1c00;
    }

    button.generate-btn:hover {
      background: #a52d00;
    }

    button.download-btn {
      background: #2c5234;
      color: #f4edd3;
      border-color: #1a3320;
    }

    button.download-btn:hover {
      background: #3a6b45;
    }

    button.bagpipe-btn {
      background: #5b2c6f;
      color: #f4edd3;
      border-color: #3d1a4a;
    }

    button.bagpipe-btn:hover {
      background: #7d3c98;
    }

    button.bagpipe-btn.playing {
      background: #8b1a1a;
      border-color: #6b1010;
      animation: pulse-glow 1s ease-in-out infinite;
    }

    .secondary-actions {
      display: none;
      gap: 0.75rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    button.download-bagpipe-btn {
      background: #4a1a5e;
      color: #f4edd3;
      border-color: #3d1a4a;
    }

    button.download-bagpipe-btn:hover {
      background: #6b2d8a;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 4px rgba(139,26,26,0.3); }
      50% { box-shadow: 0 0 12px rgba(139,26,26,0.6); }
    }

    .share-links {
      display: none;
      gap: 0.6rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .share-links span {
      font-family: 'Mona Sans', sans-serif;
      font-size: 0.95rem;
      color: #6b5240;
    }

    .share-links a {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-family: 'Mona Sans', sans-serif;
      font-size: 0.9rem;
      color: #6b5240;
      text-decoration: none;
      padding: 0.3rem 0.6rem;
      border: 1px solid #c4b48a;
      border-radius: 3px;
      transition: all 0.2s;
    }

    .share-links a:hover {
      color: #8b2500;
      border-color: #8b2500;
      background: rgba(139,37,0,0.04);
    }

    .tartan-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    #tartan-display {
      border: 4px solid #8b774b;
      border-radius: 4px;
      box-shadow: 0 4px 20px rgba(44,24,16,0.15);
      background: #faf6e9;
      display: none;
    }

    .sett-display {
      display: none;
      margin-top: 1rem;
      text-align: center;
    }

    .sett-display h3 {
      font-family: 'Mona Sans', sans-serif;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: #3d2b1f;
    }

    .sett-colors {
      display: flex;
      gap: 4px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }

    .sett-color {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .sett-swatch {
      width: 32px;
      height: 32px;
      border: 1px solid #8b774b;
      border-radius: 3px;
    }

    .sett-label {
      font-size: 0.7rem;
      color: #6b5240;
      font-family: monospace;
    }

    .sett-thread-count {
      font-size: 0.95rem;
      color: #6b5240;
      font-style: italic;
    }

    .palette-toggle {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding-top: 0;
      border-top: none;
    }

    .palette-toggle span {
      font-family: 'Mona Sans', sans-serif;
      font-size: 0.95rem;
      color: #6b5240;
    }

    .palette-toggle label {
      font-family: 'Mona Sans', sans-serif;
      font-size: 0.9rem;
      color: #6b5240;
      padding: 0.3rem 0.7rem;
      border: 1px solid #c4b48a;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .palette-toggle input[type="radio"] {
      display: none;
    }

    .palette-toggle input[type="radio"]:checked + label {
      color: #f4edd3;
      background: #8b2500;
      border-color: #6b1c00;
    }

    .palette-toggle label:hover {
      border-color: #8b2500;
      color: #8b2500;
    }

    .palette-toggle input[type="radio"]:checked + label:hover {
      color: #f4edd3;
    }

    .username-label {
      font-family: 'Mona Sans', sans-serif;
      font-size: 1.25rem;
      color: #3d2b1f;
      margin-bottom: 0.5rem;
      display: none;
      text-align: center;
    }

    .username-label span {
      color: #8b2500;
      font-weight: 700;
    }

    .username-label .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      vertical-align: middle;
      margin-left: 6px;
      border: 1.5px solid #8b774b;
    }

    footer {
      margin-top: auto;
      padding-top: 2rem;
      text-align: center;
      color: #8b774b;
      font-size: 0.9rem;
      font-style: italic;
    }

    .character-container {
      display: none;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    #character-svg {
      filter: drop-shadow(0 4px 12px rgba(44,24,16,0.18));
    }

    /* â”€â”€ Gallery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gallery-section {
      width: 100%;
      max-width: 900px;
      margin: 1rem auto 2rem;
      text-align: center;
    }

    .gallery-section .divider { margin: 0 auto 0.5rem; }

    .gallery-section h2 {
      font-family: 'Mona Sans', sans-serif;
      font-size: 1.5rem;
      color: #3d2b1f;
      margin-bottom: 0.25rem;
    }

    .gallery-section p.gallery-subtitle {
      font-size: 1rem;
      font-style: italic;
      color: #6b5240;
      margin-bottom: 1.25rem;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      padding: 0 0.5rem;
    }

    .gallery-card {
      position: relative;
      cursor: pointer;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid #c4b48a;
      background: #faf6e9;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      aspect-ratio: 1;
    }

    .gallery-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 8px 24px rgba(44,24,16,0.18);
      border-color: #8b2500;
    }

    .gallery-card svg {
      display: block;
      width: 100%;
      height: 100%;
    }

    .gallery-card .card-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: linear-gradient(transparent, rgba(26,15,8,0.85));
      transition: opacity 0.2s;
    }

    .gallery-card .card-avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1.5px solid rgba(255,255,255,0.6);
      flex-shrink: 0;
    }

    .gallery-card .card-username {
      font-family: 'Mona Sans', sans-serif;
      font-size: 0.8rem;
      color: #f0e8d0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gallery-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 2rem;
      color: #8b774b;
      font-style: italic;
    }

    .gallery-loading .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid #c4b48a;
      border-top-color: #8b2500;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .gallery-section.hidden {
      display: none;
    }

    /* â”€â”€ Skip link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .skip-link {
      position: absolute;
      left: -9999px;
      top: 0;
      background: #8b2500;
      color: #f4edd3;
      padding: 0.5rem 1rem;
      z-index: 1000;
      font-family: 'Mona Sans', sans-serif;
      border-radius: 0 0 4px 0;
    }
    .skip-link:focus {
      left: 0;
    }

    /* â”€â”€ Focus-visible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :focus-visible {
      outline: 2px solid #8b2500;
      outline-offset: 2px;
    }
    button:focus-visible {
      outline: 2px solid #c5a041;
      outline-offset: 2px;
    }
    .gallery-card:focus-visible {
      outline: 3px solid #c5a041;
      outline-offset: 2px;
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 8px 24px rgba(44,24,16,0.18);
    }

    /* â”€â”€ Responsive tartan SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tartan-display {
      max-width: 100%;
      height: auto;
    }

    /* â”€â”€ Error message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-error {
      display: none;
      color: #8b1a1a;
      font-size: 0.95rem;
      font-style: italic;
      text-align: center;
      margin-top: -1rem;
      margin-bottom: 1rem;
    }


    /* â”€â”€ Generate button spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .generate-btn .btn-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(244,237,211,0.3);
      border-top-color: #f4edd3;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @media (max-width: 768px) {
      header h1 { font-size: 2.2rem; }
      .input-section { gap: 0.5rem; }
      button { min-height: 44px; min-width: 44px; }
      .palette-toggle label { min-height: 44px; display: inline-flex; align-items: center; }
      .share-links a { min-height: 44px; display: inline-flex; align-items: center; }
    }

    @media (max-width: 600px) {
      header h1 { font-size: 2rem; }
      .input-section { width: 100%; padding: 0 0.5rem; }
      .input-section input[type="text"] { width: 100%; max-width: 300px; }
      .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.6rem; }
      .gallery-card .card-info { padding: 4px 5px; }
      .gallery-card .card-avatar { width: 16px; height: 16px; }
      .gallery-card .card-username { font-size: 0.7rem; }
    }

    /* â”€â”€ Reduced motion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .gallery-card:hover { transform: none; }
      .gallery-card:focus-visible { transform: none; }
    }

    /* â”€â”€ Theme toggle button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      background: rgba(44,24,16,0.08);
      border: 2px solid rgba(139,119,75,0.3);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, border-color 0.3s, transform 0.2s;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .theme-toggle:hover {
      background: rgba(44,24,16,0.15);
      border-color: rgba(139,119,75,0.5);
      transform: scale(1.1);
    }
    .theme-toggle:active { transform: scale(0.95); }
    .theme-toggle .icon-sun { display: inline; }
    .theme-toggle .icon-moon { display: none; }
    .dark-mode .theme-toggle {
      background: rgba(240,232,208,0.1);
      border-color: rgba(107,82,64,0.5);
    }
    .dark-mode .theme-toggle:hover {
      background: rgba(240,232,208,0.2);
      border-color: rgba(224,112,64,0.6);
    }
    .dark-mode .theme-toggle .icon-sun { display: none; }
    .dark-mode .theme-toggle .icon-moon { display: inline; }

    /* â”€â”€ Dark mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.dark-mode {
      background: #1a1a2e;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(139,119,75,0.05) 50px, rgba(139,119,75,0.05) 51px),
        repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(139,119,75,0.05) 50px, rgba(139,119,75,0.05) 51px);
      color: #e0d8c0;
    }
    body.dark-mode header h1, body.dark-mode header h1 a { color: #f0e8d0; }
    body.dark-mode header p.subtitle { color: #b5a78a; }
    body.dark-mode .header-nav a { color: #b5a78a; }
    body.dark-mode .header-nav a:hover { color: #e07040; border-bottom-color: #e07040; }
    body.dark-mode .divider { background: linear-gradient(90deg, transparent, #6b5240, transparent); }
    body.dark-mode .input-section label { color: #e0d8c0; }
    body.dark-mode .input-section input[type="text"] {
      background: #2a2a40;
      border-color: #6b5240;
      color: #f0e8d0;
    }
    body.dark-mode .input-section input[type="text"]::placeholder { color: #6b5240; }
    body.dark-mode .input-section input[type="text"]:focus { border-color: #e07040; }
    body.dark-mode button.generate-btn { background: #a52d00; border-color: #8b2500; }
    body.dark-mode button.generate-btn:hover { background: #c03500; }
    body.dark-mode .palette-toggle span { color: #b5a78a; }
    body.dark-mode .palette-toggle label { color: #b5a78a; border-color: #6b5240; }
    body.dark-mode .palette-toggle label:hover { color: #e07040; border-color: #e07040; }
    body.dark-mode .palette-toggle input[type="radio"]:checked + label { background: #a52d00; border-color: #8b2500; color: #f0e8d0; }
    body.dark-mode .username-label { color: #e0d8c0; }
    body.dark-mode .username-label span { color: #e07040; }
    body.dark-mode #tartan-display { border-color: #6b5240; background: #2a2a40; }
    body.dark-mode .sett-display h3 { color: #e0d8c0; }
    body.dark-mode .sett-swatch { border-color: #6b5240; }
    body.dark-mode .sett-label { color: #b5a78a; }
    body.dark-mode .sett-thread-count { color: #b5a78a; }
    body.dark-mode .share-links span { color: #b5a78a; }
    body.dark-mode .share-links a { color: #b5a78a; border-color: #6b5240; }
    body.dark-mode .share-links a:hover { color: #e07040; border-color: #e07040; background: rgba(224,112,64,0.06); }
    body.dark-mode button.download-btn { background: #1a472a; border-color: #0e3320; }
    body.dark-mode button.download-btn:hover { background: #2d5a27; }
    body.dark-mode button.bagpipe-btn { background: #5b2c6f; border-color: #3d1a4a; }
    body.dark-mode button.bagpipe-btn:hover { background: #7d3c98; }
    body.dark-mode button.download-bagpipe-btn { background: #4a1a5e; border-color: #3d1a4a; }
    body.dark-mode button.download-bagpipe-btn:hover { background: #6b2d8a; }
    body.dark-mode .gallery-section h2 { color: #f0e8d0; }
    body.dark-mode .gallery-section p.gallery-subtitle { color: #b5a78a; }
    body.dark-mode .gallery-card { border-color: #6b5240; background: #2a2a40; }
    body.dark-mode .gallery-card:hover { border-color: #e07040; }
    body.dark-mode .gallery-loading { color: #b5a78a; }
    body.dark-mode .gallery-loading .spinner { border-color: #6b5240; border-top-color: #e07040; }
    body.dark-mode footer { color: #6b5240; }
    body.dark-mode footer a { color: #6b5240; }
    body.dark-mode .input-error { color: #e07040; }
    body.dark-mode :focus-visible { outline-color: #e07040; }
    body.dark-mode .skip-link { background: #e07040; color: #1a1a2e; }

  </style>
</head>
<!-- If you're reading this, you're the kind of person who views source. We like you. -->
<body>
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle light/dark mode">
    <span class="icon-sun">â˜€ï¸</span>
    <span class="icon-moon">ğŸŒ™</span>
  </button>
  <a href="#tartan-form" class="skip-link">Skip to content</a>
  <header>
    <a href="https://leereilly.net/dev-tartan" class="invertocat-wrap" id="invertocat-link" aria-label="Dev Tartan home">
      <svg id="invertocat-svg" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <clipPath id="octocat-clip">
            <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/>
          </clipPath>
          <pattern id="octocat-tartan" patternUnits="userSpaceOnUse" x="0" y="0" width="16" height="16">
            <rect width="16" height="16" fill="#1c2541"/>
          </pattern>
        </defs>
        <rect width="16" height="16" clip-path="url(#octocat-clip)" fill="url(#octocat-tartan)"/>
      </svg>
    </a>
    <h1><a href="#" id="logo-link">Dev <span class="accent">Tartan</span></a></h1>
    <div class="divider"></div>
    <p class="subtitle">Every developer deserves their own clan</p>
    <p class="subtitle" style="font-size: 0.95rem; opacity: 0.7; margin-top: 0.3rem;">SHA-256 turns your GitHub username into a unique, deterministic tartan pattern</p>
    <nav class="header-nav">
      <a href="about.html">About</a>
      <a href="https://github.com/leereilly/dev-tartan">Source</a>
    </nav>
  </header>

  <form class="input-section" id="tartan-form">
    <label for="username">GitHub Username:</label>
    <input type="text" id="username" placeholder="e.g. octocat" autocomplete="off" required aria-label="GitHub username">
    <button type="submit" class="generate-btn" id="generate-btn">Weave Tartan</button>
  </form>

  <div class="input-error" id="input-error" role="alert">Please enter a GitHub username.</div>

  <div class="palette-toggle" id="palette-toggle">
    <span>Palette:</span>
    <input type="radio" name="palette" id="palette-traditional" value="traditional" checked>
    <label for="palette-traditional">Traditional</label>
    <input type="radio" name="palette" id="palette-github" value="github">
    <label for="palette-github">GitHub</label>
    <input type="radio" name="palette" id="palette-microsoft" value="microsoft">
    <label for="palette-microsoft">Microsoft</label>
  </div>

  <div class="username-label" id="username-label">The tartan of <span id="display-name"></span><img class="avatar" id="user-avatar" src="" alt="GitHub avatar" style="display:none;"></div>

  <div class="tartan-container" aria-live="polite">
    <svg id="tartan-display" width="500" height="500" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Generated tartan pattern"></svg>
  </div>

  <div class="secondary-actions" id="secondary-actions">
    <button type="button" class="download-btn" id="download-btn" aria-label="Download tartan as SVG">Download SVG</button>
    <button type="button" class="bagpipe-btn" id="bagpipe-btn" aria-label="Play unique bagpipe tune">ğŸµ Play Bagpipes</button>
    <button type="button" class="download-bagpipe-btn" id="download-bagpipe-btn" aria-label="Download bagpipe tune as WAV">ğŸ“¥ Download Tune</button>
  </div>

  <div class="sett-display" id="sett-display">
    <h3>Thread Count</h3>
    <div class="sett-colors" id="sett-colors"></div>
    <div class="sett-thread-count" id="sett-thread-count"></div>
  </div>

  <div class="character-container" id="character-container">
    <svg id="character-svg" width="220" height="340" viewBox="0 0 220 340" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <div class="share-links" id="share-links">
    <span>Share your tartan:</span>
    <a id="share-x" href="#" target="_blank" rel="noopener" aria-label="Share on X (Twitter)">ğ•</a>
    <a id="share-bluesky" href="#" target="_blank" rel="noopener" aria-label="Share on Bluesky">Bluesky</a>
    <a id="share-linkedin" href="#" target="_blank" rel="noopener" aria-label="Share on LinkedIn">LinkedIn</a>
    <a id="share-threads" href="#" target="_blank" rel="noopener" aria-label="Share on Threads">Threads</a>
    <a id="share-copy" href="#" aria-label="Copy link to clipboard">ğŸ“‹ Copy Link</a>
  </div>

  <section class="gallery-section" id="gallery-section">
    <h2>Recently Active Clan Members</h2>
    <div class="divider"></div>
    <p class="gallery-subtitle">Tartans of developers active on GitHub right now</p>
    <div class="gallery-grid" id="gallery-grid">
      <div class="gallery-loading" id="gallery-loading"><div class="spinner"></div> Fetching from the Highlands&hellip;</div>
    </div>
  </section>

  <!-- TODO: Add tweed mode. And maybe argyle. Actually no, argyle is for golf. We have standards. -->
  <footer>
    <p>Woven with bits &amp; bytes &bull; SHA-256 &rarr; Sett</p>
    <p><a href="https://github.com/leereilly/dev-tartan" style="color: #8b774b;">Source on GitHub</a> &bull; Built with <a href="http://github.com/features/copilot" style="color: #8b774b;">GitHub Copilot CLI</a> for the <a href="https://dev.to/leereilly/dev-tartan-deterministic-plaid-from-a-github-username-101m" style="color: #8b774b;">GitHub Copilot CLI Coding Challenge</a></p>
  </footer>

  <script>
    // Traditional tartan colour palette â€” authentic Scottish dye colours
    const PALETTES = {
      traditional: [
        { name: 'Dark Navy',      hex: '#1c2541' },
        { name: 'Royal Blue',     hex: '#2b4c7e' },
        { name: 'Azure',          hex: '#3a7ca5' },
        { name: 'Sky Blue',       hex: '#6fb3d2' },
        { name: 'Hunter Green',   hex: '#1a472a' },
        { name: 'Forest Green',   hex: '#2d5a27' },
        { name: 'Moss Green',     hex: '#4a7c59' },
        { name: 'Sage',           hex: '#87a96b' },
        { name: 'Crimson',        hex: '#8b1a1a' },
        { name: 'Scarlet',        hex: '#c41e3a' },
        { name: 'Rust',           hex: '#a0522d' },
        { name: 'Burnt Orange',   hex: '#c76f30' },
        { name: 'Gold',           hex: '#c5a041' },
        { name: 'Straw',          hex: '#d4b94e' },
        { name: 'Purple',         hex: '#5b2c6f' },
        { name: 'Heather',        hex: '#7d5a9e' },
        { name: 'Black',          hex: '#1a1a1a' },
        { name: 'Charcoal',       hex: '#3d3d3d' },
        { name: 'Grey',           hex: '#7a7a7a' },
        { name: 'Ivory',          hex: '#f0e8d0' },
      ],
      github: [
        { name: 'Level 0',       hex: '#ebedf0' },
        { name: 'Level 1',       hex: '#9be9a8' },
        { name: 'Level 2',       hex: '#40c463' },
        { name: 'Level 3',       hex: '#30a14e' },
        { name: 'Level 4',       hex: '#216e39' },
        { name: 'Dark Green',    hex: '#0e4429' },
        { name: 'Light Green',   hex: '#b7e4c7' },
        { name: 'Mint',          hex: '#69d2a0' },
        { name: 'Emerald',       hex: '#28a745' },
        { name: 'Pine',          hex: '#176f2c' },
        { name: 'Deep Forest',   hex: '#0d5524' },
        { name: 'Mist',          hex: '#d1f0dc' },
        { name: 'Seafoam',       hex: '#85e0a3' },
        { name: 'Clover',        hex: '#34d058' },
        { name: 'Fern',          hex: '#22863a' },
        { name: 'Ivy',           hex: '#144620' },
        { name: 'Ash',           hex: '#c6ced3' },
        { name: 'Slate',         hex: '#586069' },
        { name: 'Charcoal',      hex: '#24292e' },
        { name: 'Snow',          hex: '#f6f8fa' },
      ],
      microsoft: [
        { name: 'MS Red',        hex: '#f25022' },
        { name: 'MS Green',      hex: '#7fba00' },
        { name: 'MS Blue',       hex: '#00a4ef' },
        { name: 'MS Yellow',     hex: '#ffb900' },
        { name: 'Dark Red',      hex: '#a33b1f' },
        { name: 'Dark Green',    hex: '#4e7a00' },
        { name: 'Dark Blue',     hex: '#0078d4' },
        { name: 'Dark Yellow',   hex: '#d48c00' },
        { name: 'Light Red',     hex: '#f7816b' },
        { name: 'Light Green',   hex: '#b4e44b' },
        { name: 'Light Blue',    hex: '#50c8ff' },
        { name: 'Light Yellow',  hex: '#ffd54f' },
        { name: 'Coral',         hex: '#e8503a' },
        { name: 'Lime',          hex: '#6ba300' },
        { name: 'Azure',         hex: '#0063b1' },
        { name: 'Amber',         hex: '#e69500' },
        { name: 'Black',         hex: '#1a1a1a' },
        { name: 'Charcoal',      hex: '#3d3d3d' },
        { name: 'Grey',          hex: '#737373' },
        { name: 'White',         hex: '#f2f2f2' },
      ],
    };

    let currentPalette = 'traditional';
    let TARTAN_PALETTE = PALETTES.traditional;
    let _lastSett = null; // stashed for console easter egg

    // â”€â”€ Real clan tartan sett definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Traditional hex colours for tartan weaving
    const TARTAN_COLORS = {
      BK: { name: 'Black',       hex: '#101010' },
      B:  { name: 'Blue',        hex: '#003366' },
      G:  { name: 'Green',       hex: '#006400' },
      R:  { name: 'Red',         hex: '#c80000' },
      Y:  { name: 'Yellow',      hex: '#ffd700' },
      W:  { name: 'White',       hex: '#ffffff' },
      AZ: { name: 'Azure',       hex: '#5b97b0' },
      CR: { name: 'Crimson',     hex: '#dc143c' },
      PU: { name: 'Purple',      hex: '#6a2c8b' },
      GY: { name: 'Grey',        hex: '#808080' },
      BR: { name: 'Brown',       hex: '#6b3a2a' },
      LG: { name: 'Light Green', hex: '#86c67c' },
      Or: { name: 'Orange',      hex: '#ec8048' },
      Mn: { name: 'Maroon',      hex: '#800020' },
      DB: { name: 'Dark Blue',   hex: '#00008c' },
    };

    // Parse a sett string like "R 72 B 8 BK 12 Y 2" into [{color, width}, ...]
    function parseSett(settStr) {
      const tokens = settStr.trim().split(/\s+/);
      const sett = [];
      for (let i = 0; i < tokens.length - 1; i += 2) {
        const colorCode = tokens[i];
        const width = parseInt(tokens[i + 1], 10);
        const color = TARTAN_COLORS[colorCode];
        if (color && !isNaN(width)) {
          // Scale down large thread counts for better display
          sett.push({ color, width: Math.max(2, Math.round(width / 2)) });
        }
      }
      return sett;
    }

    // Clan tartan definitions â€” sett strings from public-domain sources
    // Each entry: [display name, sett string, optional aliases]
    const CLAN_TARTAN_DEFS = [
      ['Abercrombie',       'G 28 W 2 G 14 BK 14 B 4 BK 4 B 4 BK 4 B 14'],
      ['Anderson',          'R 6 AZ 12 R 2 BK 4 R 2 AZ 36 BK 6 W 6 BK 6 Y 2 BK 2 Y 2 BK 8 R 2 B 8 R 6 G 12 R 4 G 12 R 8'],
      ['Armstrong',         'G 4 BK 2 G 60 BK 24 B 4 BK 2 B 2 BK 2 B 24 R 6'],
      ['Baird',             'PU 6 G 2 PU 2 G 16 BK 16 B 16 BK 4 B 6'],
      ['Barclay',           'R 2 G 32 B 32 G 2'],
      ['Black Watch',       'B 22 BK 2 B 2 BK 2 B 2 BK 16 G 16 BK 2 G 16 BK 16 B 16 BK 2 B 2 G 10 BK 2 G 10 BK 8 DB 9 BK 1 DB 1'],
      ['Boyd',              'Y 10 G 44 BK 4 B 4 BK 4 B 4 BK 20 R 76 G 10 R 8 BK 8 W 10'],
      ['Brodie',            'R 96 W 8 B 8 BK 8 R 24 B 8 R 2 Y 8'],
      ['Bruce',             'W 2 R 16 G 4 R 4 G 12 R 2 G 12 R 4 G 4 R 16 Y 2'],
      ['Buchanan',          'BK 2 Y 12 BK 2 B 8 BK 2 G 12 B 8 G 12 BK 2 B 8 BK 2 R 16 W 2 R 16 BK 2 B 8 BK 2 Y 12'],
      ['Cameron',           'Y 2 R 32 G 12 R 4 G 12 R 4'],
      ['Campbell',          'B 22 BK 2 B 2 BK 2 B 2 BK 16 G 16 BK 2 G 16 BK 16 B 16 BK 2 B 2'],
      ['Carnegie',          'Y 2 G 4 R 2 G 2 R 4 G 12 BK 12 R 2 B 12 R 4 B 2 R 2 B 6'],
      ['Chisholm',          'R 24 PU 4 W 2 PU 4 R 6 G 16 R 6 PU 2'],
      ['Clark',             'AZ 24 BK 8 G 8 BK 8 R 24'],
      ['Cochrane',          'G 32 R 4 G 4 R 2 G 6 R 2 G 4 R 4 G 24 BK 24 R 2 B 32 R 4 B 16 Y 4'],
      ['Colquhoun',         'B 2 BK 2 B 16 BK 16 W 2 G 16 R 4'],
      ['Crawford',          'CR 12 W 4 CR 60 G 24 CR 6 G 24 CR 6'],
      ['Cunningham',        'W 6 R 2 B 2 R 56 BK 60 R 2 BK 6'],
      ['Davidson',          'R 2 B 12 G 2 B 2 G 16 BK 2 G 16 BK 2 G 2 BK 12 R 2'],
      ['Douglas',           'BK 4 AZ 4 G 16 B 16 W 2'],
      ['Drummond',          'R 72 W 2 B 6 Y 2 G 32 R 16 B 6 AZ 4 W 2'],
      ['Duncan',            'BK 8 G 42 W 6 G 42 B 42 R 8'],
      ['Dundas',            'BK 4 G 4 R 2 G 48 BK 24 B 32 BK 8'],
      ['Elliott',           'R 2 B 6 BR 8 B 32'],
      ['Erskine',           'R 8 G 2 R 56 G 48 R 2 G 12'],
      ['Farquharson',       'R 4 B 8 BK 2 B 2 BK 2 B 2 BK 16 G 16 Y 4 G 16 BK 16 B 16 BK 2 R 4'],
      ['Ferguson',          'B 48 BK 16 G 16 R 4 G 16 BK 2 W 4'],
      ['Fletcher',          'B 12 BK 2 B 12 BK 16 R 2 G 16 BK 4'],
      ['Forbes',            'B 16 BK 2 B 4 BK 2 B 4 BK 12 G 16 BK 2 W 4 BK 2 G 16 BK 12 B 16 BK 2 B 4'],
      ['Fraser',            'B 32 R 2 B 2 R 2 G 24 R 32 G 4 R 32 G 24 B 24 R 2 B 2'],
      ['Gordon',            'B 24 BK 4 B 4 BK 4 B 4 BK 24 G 24 Y 4 G 24 BK 24 B 22 BK 4 B 4'],
      ['Gow',               'R 8 G 8 R 2 B 8 R 8'],
      ['Graham',            'BK 2 B 24 BK 24 G 2 AZ 4 G 32'],
      ['Grant',             'R 12 B 2 R 4 B 4 R 64 AZ 2 R 4 B 16 R 4 G 4 R 4 G 48 R 4 B 4 R 12'],
      ['Gunn',              'R 4 G 24 BK 24 G 2 B 24 G 4'],
      ['Hamilton',          'W 2 R 18 B 12 R 2 B 12'],
      ['Hay',               'W 12 R 4 BK 2 R 4 G 8 R 96 G 24 R 4 G 4 R 4 G 72 Y 4 G 8 R 12'],
      ['Henderson',         'Y 2 BK 12 G 8 BK 2 G 32 B 2 G 8 B 12 W 2'],
      ['Home',              'B 6 G 4 B 48 BK 16 R 2 BK 4 R 2 BK 56'],
      ['Hunter',            'G 16 BK 2 G 16 BK 16 R 2 B 16 W 2 B 16 R 2 BK 16'],
      ['Innes',             'AZ 14 BK 48 R 8 BK 8 R 8 BK 8 R 48 Y 8 R 12 B 24 R 12 BK 8 G 40 BK 8 R 12 W 8'],
      ['Johnston',          'Y 6 G 4 BK 2 G 60 B 48 BK 4 B 4 BK 4'],
      ['Keith',             'BK 4 G 18 B 8 BK 8 B 8'],
      ['Kennedy',           'R 4 G 48 B 8 BK 6 B 6 BK 6 B 6 BK 6 B 8 G 24 CR 2 G 4 CR 2 G 6 Y 2 G 4 BK 4'],
      ['Kerr',              'BK 8 R 4 BK 2 R 56 BK 28 G 6 BK 2 G 4 BK 2 G 40'],
      ['Lamont',            'B 6 BK 2 B 2 BK 2 B 2 BK 8 G 8 W 2 G 8 BK 8 B 8 BK 2 B 2'],
      ['Leslie',            'BK 2 R 64 B 32 R 8 BK 12 Y 2 BK 12 R 8'],
      ['Lindsay',           'CR 6 B 4 CR 48 B 16 G 4 B 4 G 4 B 4 G 40'],
      ['Livingston',        'R 16 G 4 R 40 G 32 R 8 BK 2 R 4 BK 2 R 8 G 24'],
      ['Logan',             'Y 4 BK 2 R 2 G 32 BK 24 B 32 R 4 B 4 R 4 B 6 R 12'],
      ['MacAlister',        'R 8 AZ 2 R 2 G 12 R 24 AZ 2 R 2 G 36 R 2 AZ 2 R 64 AZ 2 R 2 G 36 R 2 AZ 2 R 24 B 16 R 16 G 16 R 8 G 16 R 64'],
      ['MacArthur',         'Y 6 G 60 BK 24 G 12 BK 64'],
      ['MacAulay',          'BK 4 R 32 G 12 R 6 G 16 W 2'],
      ['MacCallum',         'BK 2 B 12 BK 12 G 8 AZ 2 BK 4 G 16'],
      ['MacDonald',         'G 16 R 2 G 4 R 6 G 24 BK 24 R 2 B 24 R 6 B 4 R 2 B 16'],
      ['MacDougall',        'PU 8 G 16 B 12 PU 16 R 12 G 4 R 4 G 4 R 48 G 2 R 6'],
      ['MacDuff',           'R 8 BK 2 R 8 G 12 BK 8 B 6 R 16'],
      ['MacEwan',           'Y 4 BK 2 G 24 BK 24 B 24 BK 2 B 4 BK 2 B 24 BK 24 G 24 BK 2 R 4'],
      ['MacFarlane',        'R 84 BK 2 G 24 W 4 R 6 BK 2 R 6 W 4 G 4 PU 24 BK 8 R 6 W 8 G 6'],
      ['MacGregor',         'R 72 G 36 R 8 G 12 BK 2 W 4'],
      ['MacInnes',          'Y 4 BK 24 G 4 BK 4 G 4 BK 4 G 32 BK 6 AZ 6 BK 6 B 24 G 12 R 4'],
      ['MacIntyre',         'AZ 2 R 4 G 4 R 8 B 32 R 4 G 2 R 8 B 2 R 4 G 32 R 8 B 4 R 4 AZ 2'],
      ['MacKay',            'BK 6 G 28 BK 28 G 4 B 28 G 6'],
      ['MacKenzie',         'B 24 BK 4 B 4 BK 4 B 4 BK 24 G 24 BK 2 W 4 BK 2 G 24 BK 24 B 24 BK 2 R 4'],
      ['MacKinnon',         'W 4 R 8 PU 4 G 16 R 32 G 4 B 8 R 4 G 32 R 12 B 4 G 4 R 6 PU 4'],
      ['MacKintosh',        'R 48 B 12 R 6 G 24 R 8 B 2'],
      ['MacLachlan',        'R 32 BK 4 R 4 BK 4 R 4 BK 32 B 32 G 6 B 32 BK 32 R 32 BK 4 R 4'],
      ['MacLaren',          'B 48 BK 16 G 16 R 4 G 16 BK 2 Y 4'],
      ['MacLean',           'BK 2 R 4 AZ 2 R 24 G 16 BK 2 W 2 BK 2 Y 2 BK 6 AZ 2 B 8'],
      ['MacLeod',           'R 6 BK 4 G 30 BK 20 B 40 BK 4 Y 4'],
      ['MacMillan',         'R 2 Y 16 R 4 Y 16 R 6 Y 4 R 24 Y 2 R 6'],
      ['MacNab',            'G 16 CR 2 G 2 CR 2 G 2 CR 12 R 16 CR 2 R 16 CR 12 G 14 CR 2 G 2'],
      ['MacNeil',           'Y 2 BK 6 G 30 BK 28 B 32 R 4 W 2'],
      ['MacPherson',        'R 2 BK 2 W 2 R 24 AZ 8 BK 2 AZ 2 BK 2 AZ 8 BK 12 Y 2 G 16 R 24 AZ 4 R 24'],
      ['MacQuarrie',        'R 4 AZ 2 R 32 B 24 R 8 G 32 R 12'],
      ['MacRae',            'G 8 R 2 G 8 R 8 B 2 R 2 B 2 R 2 B 2 R 8 B 2 R 2 B 2 R 2 B 2 R 8 W 2 R 2 B 8 R 2 B 8 R 2 W 2 R 8 G 2 R 2 G 2 R 8 G 8 R 2 G 8'],
      ['MacTavish',         'AZ 4 R 24 B 4 AZ 12 BK 12 AZ 2'],
      ['Malcolm',           'B 2 R 2 B 12 BK 12 G 12 BK 2 Y 2 BK 2 AZ 2 BK 2 G 12 BK 12 B 12 R 2'],
      ['Matheson',          'R 4 G 4 R 24 B 20 AZ 6 G 20 R 4 G 4 R 4 G 20 R 24 G 4 R 4'],
      ['Maxwell',           'R 6 G 2 R 56 BK 12 R 8 G 32 R 6'],
      ['Menzies',           'R 10 AZ 4 W 2 G 10 R 10'],
      ['Mitchell',          'BK 4 G 24 BK 24 R 2 B 24 W 4'],
      ['Montgomery',        'BK 8 G 10 BK 8 PU 56 BK 8 R 10 BK 8'],
      ['Morrison',          'BK 6 G 28 BK 28 G 4 B 28 R 6'],
      ['Munro',             'G 4 CR 4 G 4 R 32 B 2 Y 2 R 6 B 12 R 6 Y 2 B 2 R 6 G 32 R 6 B 2 Y 2 R 48'],
      ['Murray',            'B 12 BK 2 B 2 BK 2 B 2 BK 12 G 12 R 4 G 12 BK 12 B 12 BK 2 B 4'],
      ['Napier',            'W 2 B 24 BK 8 W 4 BK 4 W 8 BK 4 W 4 BK 4 W 4 BK 8'],
      ['Ogilvy',            'W 4 AZ 10 Y 4 PU 4 R 12 W 4 R 12 W 4 R 12 BK 4 Y 10 AZ 20 R 6 AZ 20'],
      ['Oliphant',          'G 4 W 2 G 64 B 48 BK 8 B 8'],
      ['Ramsay',            'R 6 PU 2 R 60 BK 56 W 4 BK 8'],
      ['Rob Roy',           'BK 8 R 8'],
      ['Robertson',         'R 2 G 2 R 18 B 2 R 2 G 18 R 2 B 18 R 2 G 2 R 18 G 2 R 2'],
      ['Rose',              'G 4 R 56 B 12 R 10 B 4 R 4 B 4 R 22 W 4'],
      ['Ross',              'G 36 R 4 G 36 R 36 G 4 R 8 G 4 R 36 B 36 R 4 B 36 R 36 B 2 R 2 B 4 R 2 B 2 R 36 B 2 R 2 B 4 R 2 B 2 R 36 G 36 R 4 G 36'],
      ['Scott',             'G 8 R 6 BK 2 R 56 G 28 R 8 G 8 W 6 G 8 R 8'],
      ['Shaw',              'AZ 10 BK 2 R 60 PU 30 R 16 G 60 R 16 PU 4'],
      ['Sinclair',          'R 60 G 24 BK 10 W 4 AZ 12 R 60'],
      ['Skene',             'B 2 R 6 G 18 R 6 B 2 R 6 B 18'],
      ['Stewart Royal',     'R 72 B 8 BK 12 Y 2 BK 2 W 2 BK 2 G 16 R 8 BK 2 R 4 W 2'],
      ['Stewart Hunting',   'G 4 B 14 BK 2 B 2 BK 2 B 2 BK 6 G 22 R 4 G 22 BK 6 G 4 BK 12 G 4 BK 12 G 4 BK 6 G 22 Y 4 G 22 BK 6 B 2 BK 2 B 2 BK 2 B 14 G 4'],
      ['Stewart Dress',     'W 72 B 8 BK 12 Y 2 BK 2 W 2 BK 2 G 16 R 8 BK 2 R 4 W 2'],
      ['Sutherland',        'G 12 W 4 G 48 BK 24 B 6 BK 4 B 4 BK 4 B 24 R 2 B 2 R 6'],
      ['Urquhart',          'R 4 G 6 BK 6 G 96 BK 48 B 16 BK 6 B 6 BK 6 B 48 W 4 B 8'],
      ['Wallace',           'BK 2 R 16 BK 16 Y 2'],
      ['Wemyss',            'R 8 G 2 R 48 BK 8 R 8 BK 24 W 2 BK 24 R 8'],
    ];

    // Build lookup map: lowercase name â†’ { displayName, sett }
    // Also index common alternate spellings (e.g. "stuart" â†’ Stewart Royal)
    const CLAN_TARTANS = {};
    const CLAN_ALIASES = {
      'stuart': 'stewart royal', 'stewart': 'stewart royal',
      'macdonell': 'macdonald', 'mcdonald': 'macdonald', 'mcdonell': 'macdonald',
      'mcgregor': 'macgregor', 'mcleod': 'macleod', 'mckay': 'mackay',
      'mckenzie': 'mackenzie', 'mckinnon': 'mackinnon', 'mckintosh': 'mackintosh',
      'mclean': 'maclean', 'mclaren': 'maclaren', 'mclachlan': 'maclachlan',
      'mcmillan': 'macmillan', 'mcneil': 'macneil', 'mcnab': 'macnab',
      'mcpherson': 'macpherson', 'mcrae': 'macrae', 'mcintyre': 'macintyre',
      'mcarthur': 'macarthur', 'mcaulay': 'macaulay', 'mcewan': 'macewan',
      'mcfarlane': 'macfarlane', 'mctavish': 'mactavish', 'mcinnes': 'macinnes',
      'mccallum': 'maccallum', 'mcdougall': 'macdougall', 'mcduff': 'macduff',
      'mcquarrie': 'macquarrie', 'mcalister': 'macalister', 'mcmalcolm': 'malcolm',
      'fergusson': 'ferguson', 'johnstone': 'johnston', 'livingstone': 'livingston',
      'ogilvie': 'ogilvy', 'blackwatch': 'black watch',
      'robroy': 'rob roy', 'rob_roy': 'rob roy',
    };
    CLAN_TARTAN_DEFS.forEach(([name, settStr]) => {
      CLAN_TARTANS[name.toLowerCase()] = { displayName: name, sett: parseSett(settStr) };
    });

    // Look up a clan tartan by name (returns { displayName, sett } or null)
    function lookupClanTartan(name) {
      const key = name.toLowerCase().trim();
      if (CLAN_TARTANS[key]) return CLAN_TARTANS[key];
      const aliased = CLAN_ALIASES[key];
      if (aliased && CLAN_TARTANS[aliased]) return CLAN_TARTANS[aliased];
      // Try with "mac" prefix for "mc" names not explicitly aliased
      if (key.startsWith('mc') && !key.startsWith('mac')) {
        const macKey = 'mac' + key.slice(2);
        if (CLAN_TARTANS[macKey]) return CLAN_TARTANS[macKey];
      }
      return null;
    }

    // Hash a string to SHA-256 and return byte array
    async function sha256(str) {
      const data = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(hashBuffer);
    }

    // Derive a tartan sett (colour+width sequence) from hash bytes
    function deriveSett(hashBytes) {
      // Determine number of colours: 4-6, from first byte
      const numColors = 4 + (hashBytes[0] % 3); // 4, 5, or 6

      // Pick colours from palette using hash bytes
      const colors = [];
      for (let i = 0; i < numColors; i++) {
        const idx = hashBytes[1 + i] % TARTAN_PALETTE.length;
        const color = TARTAN_PALETTE[idx];
        // Avoid duplicate colours
        if (!colors.find(c => c.hex === color.hex)) {
          colors.push(color);
        } else {
          // Pick next available
          const altIdx = (idx + 7) % TARTAN_PALETTE.length;
          colors.push(TARTAN_PALETTE[altIdx]);
        }
      }

      // Derive thread counts (widths) from subsequent hash bytes
      // Traditional tartans have varying stripe widths: thin (2-6), medium (8-16), wide (18-36)
      const threadCounts = [];
      for (let i = 0; i < colors.length; i++) {
        const byte = hashBytes[8 + i];
        // Map byte to a thread count: bias toward variety
        let count;
        if (byte < 64) {
          count = 2 + (byte % 5);       // thin: 2-6
        } else if (byte < 180) {
          count = 8 + (byte % 9);        // medium: 8-16
        } else {
          count = 18 + (byte % 19);      // wide: 18-36
        }
        threadCounts.push(count);
      }

      // Build the sett: sequence of { color, width }
      const sett = colors.map((c, i) => ({
        color: c,
        width: threadCounts[i]
      }));

      return sett;
    }

    // Create the full symmetric stripe sequence from a sett
    // Traditional tartans reflect: A B C D C B A B C D C B A ...
    function expandSett(sett) {
      if (sett.length <= 1) return sett;
      // pivot: full sett forward, then reverse without first and last (mirror)
      const forward = [...sett];
      const reverse = [...sett].slice(1, -1).reverse();
      return [...forward, ...reverse];
    }

    // Render the tartan SVG with weaving animation
    function renderTartan(svg, sett, size = 500, animate = true) {
      svg.innerHTML = '';
      svg.setAttribute('width', size);
      svg.setAttribute('height', size);
      svg.setAttribute('viewBox', `0 0 ${size} ${size}`);

      const symmetricSett = expandSett(sett);

      // Calculate total width of one repeat
      const repeatWidth = symmetricSett.reduce((sum, s) => sum + s.width, 0);
      if (repeatWidth === 0) return;

      // Scale factor to fill the SVG nicely (aim for ~3-4 repeats)
      const targetRepeats = 3;
      const scale = size / (repeatWidth * targetRepeats);

      // Create defs for the pattern and clip path
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

      // Clip path to keep everything inside the canvas
      const clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');
      clipPath.setAttribute('id', 'tartan-clip');
      const clipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      clipRect.setAttribute('width', size);
      clipRect.setAttribute('height', size);
      clipPath.appendChild(clipRect);
      defs.appendChild(clipPath);

      // Background
      const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bg.setAttribute('width', size);
      bg.setAttribute('height', size);
      bg.setAttribute('fill', sett[0].color.hex);
      if (animate) bg.setAttribute('opacity', '0');
      svg.appendChild(bg);

      // Draw warp (vertical stripes) with reduced opacity
      const warpGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      warpGroup.setAttribute('opacity', '0.9');
      warpGroup.setAttribute('clip-path', 'url(#tartan-clip)');
      const warpRects = [];
      let x = 0;
      while (x < size) {
        for (const stripe of symmetricSett) {
          const w = stripe.width * scale;
          if (x + w > size + w) break;
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', x);
          rect.setAttribute('width', Math.ceil(w));
          rect.setAttribute('height', size);
          rect.setAttribute('fill', stripe.color.hex);
          if (animate) {
            rect.setAttribute('y', -size);
          } else {
            rect.setAttribute('y', 0);
          }
          warpGroup.appendChild(rect);
          warpRects.push(rect);
          x += w;
        }
      }
      svg.appendChild(warpGroup);

      // Draw weft (horizontal stripes) with transparency for woven effect
      const weftGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      weftGroup.setAttribute('opacity', '0.55');
      weftGroup.setAttribute('style', 'mix-blend-mode: multiply;');
      weftGroup.setAttribute('clip-path', 'url(#tartan-clip)');
      const weftRects = [];
      let y = 0;
      while (y < size) {
        for (const stripe of symmetricSett) {
          const h = stripe.width * scale;
          if (y + h > size + h) break;
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('y', y);
          rect.setAttribute('height', Math.ceil(h));
          rect.setAttribute('width', size);
          rect.setAttribute('fill', stripe.color.hex);
          if (animate) {
            rect.setAttribute('x', -size);
          } else {
            rect.setAttribute('x', 0);
          }
          weftGroup.appendChild(rect);
          weftRects.push(rect);
          y += h;
        }
      }
      svg.appendChild(weftGroup);

      // Add subtle twill texture overlay for authenticity
      const twillPattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
      twillPattern.setAttribute('id', 'twill');
      twillPattern.setAttribute('width', '4');
      twillPattern.setAttribute('height', '4');
      twillPattern.setAttribute('patternUnits', 'userSpaceOnUse');

      const twillLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      twillLine1.setAttribute('x', '0'); twillLine1.setAttribute('y', '0');
      twillLine1.setAttribute('width', '2'); twillLine1.setAttribute('height', '2');
      twillLine1.setAttribute('fill', 'rgba(255,255,255,0.04)');
      twillPattern.appendChild(twillLine1);

      const twillLine2 = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      twillLine2.setAttribute('x', '2'); twillLine2.setAttribute('y', '2');
      twillLine2.setAttribute('width', '2'); twillLine2.setAttribute('height', '2');
      twillLine2.setAttribute('fill', 'rgba(0,0,0,0.04)');
      twillPattern.appendChild(twillLine2);

      defs.appendChild(twillPattern);
      svg.insertBefore(defs, svg.firstChild);

      const twillOverlay = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      twillOverlay.setAttribute('width', size);
      twillOverlay.setAttribute('height', size);
      twillOverlay.setAttribute('fill', 'url(#twill)');
      if (animate) twillOverlay.setAttribute('opacity', '0');
      svg.appendChild(twillOverlay);

      // Animate the weaving
      if (animate) {
        animateWeaving(bg, warpRects, weftRects, twillOverlay, size);
      }
    }

    // Animate warp threads dropping in, then weft threads sliding in
    function animateWeaving(bg, warpRects, weftRects, twillOverlay, size) {
      const warpDuration = 600;   // ms for all warp threads
      const weftDuration = 600;   // ms for all weft threads
      const staggerMax = 80;      // max stagger offset between first and last thread
      const easeOut = t => 1 - Math.pow(1 - t, 3); // cubic ease-out

      // Fade in background
      bg.setAttribute('opacity', '1');
      bg.style.transition = 'opacity 0.3s ease';

      const startTime = performance.now();

      function tick(now) {
        const elapsed = now - startTime;

        // Phase 1: Warp threads drop in (0 â†’ warpDuration)
        if (elapsed < warpDuration + staggerMax) {
          for (let i = 0; i < warpRects.length; i++) {
            const stagger = (i / Math.max(warpRects.length - 1, 1)) * staggerMax;
            const t = Math.max(0, Math.min(1, (elapsed - stagger) / warpDuration));
            const easedT = easeOut(t);
            const yPos = -size + easedT * size;
            warpRects[i].setAttribute('y', yPos);
          }
        } else {
          // Snap warp to final position
          for (const r of warpRects) r.setAttribute('y', 0);
        }

        // Phase 2: Weft threads slide in (after warp finishes, with slight overlap)
        const weftStart = warpDuration * 0.6;
        if (elapsed > weftStart) {
          const weftElapsed = elapsed - weftStart;
          for (let i = 0; i < weftRects.length; i++) {
            const stagger = (i / Math.max(weftRects.length - 1, 1)) * staggerMax;
            const t = Math.max(0, Math.min(1, (weftElapsed - stagger) / weftDuration));
            const easedT = easeOut(t);
            const xPos = -size + easedT * size;
            weftRects[i].setAttribute('x', xPos);
          }
        }

        // Phase 3: Fade in twill overlay
        const twillStart = weftStart + weftDuration * 0.5;
        if (elapsed > twillStart) {
          const twillT = Math.min(1, (elapsed - twillStart) / 400);
          twillOverlay.setAttribute('opacity', twillT);
        }

        // Keep animating until everything is done
        const totalDuration = weftStart + weftDuration + staggerMax + 400;
        if (elapsed < totalDuration) {
          requestAnimationFrame(tick);
        } else {
          // Snap everything to final state
          for (const r of warpRects) r.setAttribute('y', 0);
          for (const r of weftRects) r.setAttribute('x', 0);
          twillOverlay.setAttribute('opacity', '1');
        }
      }

      requestAnimationFrame(tick);
    }

    // Display the sett information
    function displaySett(sett) {
      const colorsDiv = document.getElementById('sett-colors');
      const threadCountDiv = document.getElementById('sett-thread-count');
      colorsDiv.innerHTML = '';

      const threadParts = [];
      sett.forEach(s => {
        const swatch = document.createElement('div');
        swatch.className = 'sett-color';
        swatch.innerHTML = `
          <div class="sett-swatch" style="background:${s.color.hex}"></div>
          <span class="sett-label">${s.color.name}</span>
        `;
        colorsDiv.appendChild(swatch);

        // Thread count abbreviation: first letter of colour name + count
        const abbr = s.color.name.split(' ').map(w => w[0]).join('');
        threadParts.push(`${abbr}/${s.width}`);
      });

      threadCountDiv.textContent = threadParts.join('  ');
      document.getElementById('sett-display').style.display = 'block';
    }

    // Download SVG
    function downloadSVG() {
      const svg = document.getElementById('tartan-display');
      const serializer = new XMLSerializer();
      let source = serializer.serializeToString(svg);

      // Add XML declaration and namespace
      if (!source.includes('xmlns=')) {
        source = source.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
      }
      source = '<?xml version="1.0" encoding="UTF-8"?>\n' + source;

      const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const username = document.getElementById('username').value.trim();
      a.href = url;
      a.download = `${username}-tartan.svg`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Render an SVG character wearing a kilt with the tartan pattern
    function renderCharacter(sett, hashBytes) {
      const svg = document.getElementById('character-svg');
      svg.innerHTML = '';
      const ns = 'http://www.w3.org/2000/svg';

      // Derive personalized colors from hash
      const HAIR_COLORS = ['#1a1a1a', '#3b2314', '#5a3825', '#8b6a4a', '#c4956a', '#d4a76a', '#8b1a1a', '#2b4c7e'];
      const hairColor = HAIR_COLORS[hashBytes[28] % HAIR_COLORS.length];
      const pomPomColor = sett.length > 1 ? sett[1].color.hex : '#c41e3a';

      const defs = document.createElementNS(ns, 'defs');

      // Build a tartan pattern for the kilt
      const symmetricSett = expandSett(sett);
      const repeatWidth = symmetricSett.reduce((sum, s) => sum + s.width, 0);
      const patternSize = 60;
      const scale = patternSize / (repeatWidth || 1);

      const tartanPat = document.createElementNS(ns, 'pattern');
      tartanPat.setAttribute('id', 'kilt-tartan');
      tartanPat.setAttribute('width', patternSize);
      tartanPat.setAttribute('height', patternSize);
      tartanPat.setAttribute('patternUnits', 'userSpaceOnUse');

      // Pattern background
      const patBg = document.createElementNS(ns, 'rect');
      patBg.setAttribute('width', patternSize);
      patBg.setAttribute('height', patternSize);
      patBg.setAttribute('fill', sett[0].color.hex);
      tartanPat.appendChild(patBg);

      // Warp stripes (vertical)
      const warpG = document.createElementNS(ns, 'g');
      warpG.setAttribute('opacity', '0.9');
      let px = 0;
      for (const stripe of symmetricSett) {
        const w = stripe.width * scale;
        const r = document.createElementNS(ns, 'rect');
        r.setAttribute('x', px); r.setAttribute('y', 0);
        r.setAttribute('width', Math.ceil(w)); r.setAttribute('height', patternSize);
        r.setAttribute('fill', stripe.color.hex);
        warpG.appendChild(r);
        px += w;
      }
      tartanPat.appendChild(warpG);

      // Weft stripes (horizontal)
      const weftG = document.createElementNS(ns, 'g');
      weftG.setAttribute('opacity', '0.55');
      weftG.setAttribute('style', 'mix-blend-mode: multiply;');
      let py = 0;
      for (const stripe of symmetricSett) {
        const h = stripe.width * scale;
        const r = document.createElementNS(ns, 'rect');
        r.setAttribute('x', 0); r.setAttribute('y', py);
        r.setAttribute('width', patternSize); r.setAttribute('height', Math.ceil(h));
        r.setAttribute('fill', stripe.color.hex);
        weftG.appendChild(r);
        py += h;
      }
      tartanPat.appendChild(weftG);
      defs.appendChild(tartanPat);

      // Skin tone gradient
      const skinGrad = document.createElementNS(ns, 'radialGradient');
      skinGrad.setAttribute('id', 'skin-grad');
      const s1 = document.createElementNS(ns, 'stop');
      s1.setAttribute('offset', '0%'); s1.setAttribute('stop-color', '#f5d0a9');
      const s2 = document.createElementNS(ns, 'stop');
      s2.setAttribute('offset', '100%'); s2.setAttribute('stop-color', '#e8b88a');
      skinGrad.appendChild(s1); skinGrad.appendChild(s2);
      defs.appendChild(skinGrad);

      svg.appendChild(defs);

      // â”€â”€ Draw the character â”€â”€

      // Legs (behind kilt)
      const legStyle = 'fill:url(#skin-grad);stroke:#c4956a;stroke-width:1.5';
      const leftLeg = document.createElementNS(ns, 'rect');
      leftLeg.setAttribute('x', 75); leftLeg.setAttribute('y', 230);
      leftLeg.setAttribute('width', 22); leftLeg.setAttribute('height', 65);
      leftLeg.setAttribute('rx', 8);
      leftLeg.setAttribute('style', legStyle);
      svg.appendChild(leftLeg);

      const rightLeg = document.createElementNS(ns, 'rect');
      rightLeg.setAttribute('x', 123); rightLeg.setAttribute('y', 230);
      rightLeg.setAttribute('width', 22); rightLeg.setAttribute('height', 65);
      rightLeg.setAttribute('rx', 8);
      rightLeg.setAttribute('style', legStyle);
      svg.appendChild(rightLeg);

      // Knee-high socks (hose)
      [[75, 260], [123, 260]].forEach(([lx, ly]) => {
        const sock = document.createElementNS(ns, 'rect');
        sock.setAttribute('x', lx); sock.setAttribute('y', ly);
        sock.setAttribute('width', 22); sock.setAttribute('height', 42);
        sock.setAttribute('rx', 8);
        sock.setAttribute('style', 'fill:#f0e8d0;stroke:#c4b48a;stroke-width:1');
        svg.appendChild(sock);

        // Sock cuff fold
        const cuff = document.createElementNS(ns, 'rect');
        cuff.setAttribute('x', lx - 1); cuff.setAttribute('y', ly);
        cuff.setAttribute('width', 24); cuff.setAttribute('height', 8);
        cuff.setAttribute('rx', 3);
        cuff.setAttribute('style', 'fill:#f0e8d0;stroke:#c4b48a;stroke-width:1');
        svg.appendChild(cuff);
      });

      // Shoes (ghillie brogues)
      [[71, 295], [119, 295]].forEach(([sx, sy]) => {
        const shoe = document.createElementNS(ns, 'rect');
        shoe.setAttribute('x', sx); shoe.setAttribute('y', sy);
        shoe.setAttribute('width', 30); shoe.setAttribute('height', 14);
        shoe.setAttribute('rx', 5);
        shoe.setAttribute('style', 'fill:#3d2b1f;stroke:#2c1810;stroke-width:1');
        svg.appendChild(shoe);
      });

      // Kilt (the tartan!)
      const kilt = document.createElementNS(ns, 'path');
      kilt.setAttribute('d', 'M65,170 L60,240 Q65,248 110,248 Q155,248 160,240 L155,170 Z');
      kilt.setAttribute('fill', 'url(#kilt-tartan)');
      kilt.setAttribute('stroke', '#4a3728');
      kilt.setAttribute('stroke-width', '1.5');
      svg.appendChild(kilt);

      // Kilt pleats (subtle lines)
      for (let kx = 72; kx < 150; kx += 10) {
        const pleat = document.createElementNS(ns, 'line');
        pleat.setAttribute('x1', kx); pleat.setAttribute('y1', 180);
        pleat.setAttribute('x2', kx - 2); pleat.setAttribute('y2', 242);
        pleat.setAttribute('stroke', 'rgba(0,0,0,0.12)');
        pleat.setAttribute('stroke-width', '1');
        svg.appendChild(pleat);
      }

      // Belt
      const belt = document.createElementNS(ns, 'rect');
      belt.setAttribute('x', 65); belt.setAttribute('y', 168);
      belt.setAttribute('width', 90); belt.setAttribute('height', 8);
      belt.setAttribute('rx', 2);
      belt.setAttribute('fill', '#3d2b1f');
      belt.setAttribute('stroke', '#2c1810');
      belt.setAttribute('stroke-width', '1');
      svg.appendChild(belt);

      // Belt buckle
      const buckle = document.createElementNS(ns, 'rect');
      buckle.setAttribute('x', 104); buckle.setAttribute('y', 169);
      buckle.setAttribute('width', 12); buckle.setAttribute('height', 6);
      buckle.setAttribute('rx', 1);
      buckle.setAttribute('fill', '#c5a041');
      buckle.setAttribute('stroke', '#8b774b');
      buckle.setAttribute('stroke-width', '0.5');
      svg.appendChild(buckle);

      // Torso / shirt (black t-shirt)
      const torso = document.createElementNS(ns, 'path');
      torso.setAttribute('d', 'M72,105 L65,175 L155,175 L148,105 Q130,95 110,95 Q90,95 72,105 Z');
      torso.setAttribute('fill', '#1a1a1a');
      torso.setAttribute('stroke', '#333333');
      torso.setAttribute('stroke-width', '1.5');
      svg.appendChild(torso);

      // GitHub Metal logo on shirt
      const logoG = document.createElementNS(ns, 'g');
      logoG.setAttribute('transform', 'translate(88, 115)');

      // Orange ring
      const ring = document.createElementNS(ns, 'circle');
      ring.setAttribute('cx', 22); ring.setAttribute('cy', 20);
      ring.setAttribute('r', 18);
      ring.setAttribute('fill', 'none');
      ring.setAttribute('stroke', '#d4881f');
      ring.setAttribute('stroke-width', '3');
      logoG.appendChild(ring);

      // Crossed swords behind the ring
      const sword1 = document.createElementNS(ns, 'line');
      sword1.setAttribute('x1', 2); sword1.setAttribute('y1', 0);
      sword1.setAttribute('x2', 42); sword1.setAttribute('y2', 40);
      sword1.setAttribute('stroke', '#8a8a8a');
      sword1.setAttribute('stroke-width', '2');
      sword1.setAttribute('stroke-linecap', 'round');
      logoG.appendChild(sword1);

      const sword2 = document.createElementNS(ns, 'line');
      sword2.setAttribute('x1', 42); sword2.setAttribute('y1', 0);
      sword2.setAttribute('x2', 2); sword2.setAttribute('y2', 40);
      sword2.setAttribute('stroke', '#8a8a8a');
      sword2.setAttribute('stroke-width', '2');
      sword2.setAttribute('stroke-linecap', 'round');
      logoG.appendChild(sword2);

      // Sword hilts (small crossbars)
      [[4, 3], [40, 3], [4, 37], [40, 37]].forEach(([hx, hy]) => {
        const hilt = document.createElementNS(ns, 'line');
        hilt.setAttribute('x1', hx - 3); hilt.setAttribute('y1', hy);
        hilt.setAttribute('x2', hx + 3); hilt.setAttribute('y2', hy);
        hilt.setAttribute('stroke', '#c4956a');
        hilt.setAttribute('stroke-width', '2');
        hilt.setAttribute('stroke-linecap', 'round');
        logoG.appendChild(hilt);
      });

      // "GH" text in metal style
      const ghText = document.createElementNS(ns, 'text');
      ghText.setAttribute('x', 22); ghText.setAttribute('y', 25);
      ghText.setAttribute('text-anchor', 'middle');
      ghText.setAttribute('font-family', 'Impact, Arial Black, sans-serif');
      ghText.setAttribute('font-size', '14');
      ghText.setAttribute('font-weight', 'bold');
      ghText.setAttribute('fill', '#cc1100');
      ghText.setAttribute('stroke', '#880000');
      ghText.setAttribute('stroke-width', '0.5');
      ghText.textContent = 'GH';
      logoG.appendChild(ghText);

      // Inner pentagram hint (small inverted V)
      const penta = document.createElementNS(ns, 'path');
      penta.setAttribute('d', 'M18,10 L22,30 L26,10');
      penta.setAttribute('fill', 'none');
      penta.setAttribute('stroke', '#666');
      penta.setAttribute('stroke-width', '1');
      penta.setAttribute('opacity', '0.5');
      logoG.appendChild(penta);

      svg.appendChild(logoG);

      // Shirt collar lines (dark for black t-shirt)
      const collarL = document.createElementNS(ns, 'line');
      collarL.setAttribute('x1', 100); collarL.setAttribute('y1', 97);
      collarL.setAttribute('x2', 95); collarL.setAttribute('y2', 120);
      collarL.setAttribute('stroke', '#333333'); collarL.setAttribute('stroke-width', '1');
      svg.appendChild(collarL);
      const collarR = document.createElementNS(ns, 'line');
      collarR.setAttribute('x1', 120); collarR.setAttribute('y1', 97);
      collarR.setAttribute('x2', 125); collarR.setAttribute('y2', 120);
      collarR.setAttribute('stroke', '#333333'); collarR.setAttribute('stroke-width', '1');
      svg.appendChild(collarR);

      // Arms
      const armStyle = 'fill:url(#skin-grad);stroke:#c4956a;stroke-width:1.5';
      const leftArm = document.createElementNS(ns, 'path');
      leftArm.setAttribute('d', 'M72,108 Q55,115 48,145 Q45,160 50,170 L58,168 Q58,155 60,140 Q65,120 75,112 Z');
      leftArm.setAttribute('style', armStyle);
      svg.appendChild(leftArm);

      const rightArm = document.createElementNS(ns, 'path');
      rightArm.setAttribute('d', 'M148,108 Q165,115 172,145 Q175,160 170,170 L162,168 Q162,155 160,140 Q155,120 145,112 Z');
      rightArm.setAttribute('style', armStyle);
      svg.appendChild(rightArm);

      // Sporran (pouch hanging from belt)
      const sporran = document.createElementNS(ns, 'ellipse');
      sporran.setAttribute('cx', 110); sporran.setAttribute('cy', 200);
      sporran.setAttribute('rx', 14); sporran.setAttribute('ry', 18);
      sporran.setAttribute('fill', '#4a3728');
      sporran.setAttribute('stroke', '#2c1810');
      sporran.setAttribute('stroke-width', '1');
      svg.appendChild(sporran);

      // Sporran tassels
      for (let tx = 103; tx <= 117; tx += 7) {
        const tassel = document.createElementNS(ns, 'line');
        tassel.setAttribute('x1', tx); tassel.setAttribute('y1', 215);
        tassel.setAttribute('x2', tx); tassel.setAttribute('y2', 225);
        tassel.setAttribute('stroke', '#2c1810');
        tassel.setAttribute('stroke-width', '2');
        tassel.setAttribute('stroke-linecap', 'round');
        svg.appendChild(tassel);
      }

      // Sporran chain
      const chain = document.createElementNS(ns, 'path');
      chain.setAttribute('d', 'M80,178 Q95,188 110,182 Q125,188 140,178');
      chain.setAttribute('fill', 'none');
      chain.setAttribute('stroke', '#c5a041');
      chain.setAttribute('stroke-width', '1.5');
      svg.appendChild(chain);

      // Head
      const head = document.createElementNS(ns, 'ellipse');
      head.setAttribute('cx', 110); head.setAttribute('cy', 65);
      head.setAttribute('rx', 30); head.setAttribute('ry', 35);
      head.setAttribute('fill', 'url(#skin-grad)');
      head.setAttribute('stroke', '#c4956a');
      head.setAttribute('stroke-width', '1.5');
      svg.appendChild(head);

      // Hair (simple arc on top)
      const hair = document.createElementNS(ns, 'path');
      hair.setAttribute('d', 'M78,55 Q80,28 110,25 Q140,28 142,55 Q138,35 110,33 Q82,35 78,55 Z');
      hair.setAttribute('fill', hairColor);
      svg.appendChild(hair);

      // Eyes
      [[98, 60], [122, 60]].forEach(([ex, ey]) => {
        const eye = document.createElementNS(ns, 'ellipse');
        eye.setAttribute('cx', ex); eye.setAttribute('cy', ey);
        eye.setAttribute('rx', 4); eye.setAttribute('ry', 5);
        eye.setAttribute('fill', 'white');
        eye.setAttribute('stroke', '#4a3728');
        eye.setAttribute('stroke-width', '0.8');
        svg.appendChild(eye);
        const pupil = document.createElementNS(ns, 'circle');
        pupil.setAttribute('cx', ex); pupil.setAttribute('cy', ey + 1);
        pupil.setAttribute('r', 2.5);
        pupil.setAttribute('fill', '#2c1810');
        svg.appendChild(pupil);
        const glint = document.createElementNS(ns, 'circle');
        glint.setAttribute('cx', ex + 1); glint.setAttribute('cy', ey - 1);
        glint.setAttribute('r', 0.8);
        glint.setAttribute('fill', 'white');
        svg.appendChild(glint);
      });

      // Smile
      const smile = document.createElementNS(ns, 'path');
      smile.setAttribute('d', 'M100,76 Q110,84 120,76');
      smile.setAttribute('fill', 'none');
      smile.setAttribute('stroke', '#8b5e3c');
      smile.setAttribute('stroke-width', '1.5');
      smile.setAttribute('stroke-linecap', 'round');
      svg.appendChild(smile);

      // Eyebrows
      [[93, 52, 103, 50], [117, 50, 127, 52]].forEach(([x1, y1, x2, y2]) => {
        const brow = document.createElementNS(ns, 'line');
        brow.setAttribute('x1', x1); brow.setAttribute('y1', y1);
        brow.setAttribute('x2', x2); brow.setAttribute('y2', y2);
        brow.setAttribute('stroke', hairColor);
        brow.setAttribute('stroke-width', '2');
        brow.setAttribute('stroke-linecap', 'round');
        svg.appendChild(brow);
      });

      // Tam o'shanter (beret)
      const tam = document.createElementNS(ns, 'ellipse');
      tam.setAttribute('cx', 110); tam.setAttribute('cy', 35);
      tam.setAttribute('rx', 35); tam.setAttribute('ry', 12);
      tam.setAttribute('fill', 'url(#kilt-tartan)');
      tam.setAttribute('stroke', '#4a3728');
      tam.setAttribute('stroke-width', '1.5');
      svg.appendChild(tam);

      const tamTop = document.createElementNS(ns, 'path');
      tamTop.setAttribute('d', 'M80,35 Q85,12 110,10 Q135,12 140,35');
      tamTop.setAttribute('fill', 'url(#kilt-tartan)');
      tamTop.setAttribute('stroke', '#4a3728');
      tamTop.setAttribute('stroke-width', '1.5');
      svg.appendChild(tamTop);

      // Tam pom-pom
      const pomPom = document.createElementNS(ns, 'circle');
      pomPom.setAttribute('cx', 110); pomPom.setAttribute('cy', 10);
      pomPom.setAttribute('r', 6);
      pomPom.setAttribute('fill', pomPomColor);
      pomPom.setAttribute('stroke', '#4a3728');
      pomPom.setAttribute('stroke-width', '0.8');
      svg.appendChild(pomPom);

      // Show container
      document.getElementById('character-container').style.display = 'flex';
    }

    // Main generate handler
    async function generateTartan(username) {
      if (bagpipePlaying) stopBagpipes();

      // Loading state
      const genBtn = document.getElementById('generate-btn');
      const origBtnText = genBtn.textContent;
      genBtn.innerHTML = '<span class="btn-spinner"></span>Weavingâ€¦';
      genBtn.disabled = true;

      // Check if this is a real clan name with a traditional tartan
      const clanMatch = lookupClanTartan(username);
      let sett, hashBytes;

      if (clanMatch) {
        // Use the authentic clan tartan sett
        sett = clanMatch.sett;
        hashBytes = await sha256(username.toLowerCase());
      } else {
        // Generate from SHA-256 hash as usual
        hashBytes = await sha256(username.toLowerCase());
        sett = deriveSett(hashBytes);
      }

      const svg = document.getElementById('tartan-display');
      renderTartan(svg, sett);
      _lastSett = sett; // stash for console easter egg

      svg.style.display = 'block';
      document.getElementById('secondary-actions').style.display = 'flex';
      document.getElementById('username-label').style.display = 'block';

      const labelEl = document.getElementById('username-label');
      const displayNameEl = document.getElementById('display-name');
      if (clanMatch) {
        svg.setAttribute('aria-label', `${clanMatch.displayName} clan tartan`);
        labelEl.childNodes[0].textContent = 'The ';
        displayNameEl.textContent = clanMatch.displayName + ' tartan';
      } else {
        svg.setAttribute('aria-label', `Generated tartan pattern for ${username}`);
        labelEl.childNodes[0].textContent = 'The tartan of ';
        displayNameEl.textContent = username;
      }

      // Show user avatar (only for non-clan lookups, as clan names aren't GitHub users)
      const avatar = document.getElementById('user-avatar');
      if (clanMatch) {
        avatar.style.display = 'none';
      } else {
        avatar.src = `https://github.com/${encodeURIComponent(username)}.png?size=56`;
        avatar.alt = `${username}'s GitHub avatar`;
        avatar.style.display = 'inline';
        avatar.onerror = function() { this.style.display = 'none'; };
      }

      displaySett(sett);

      // Draw the character wearing the tartan kilt (personalized via hash)
      renderCharacter(sett, hashBytes);
      // Keep the default page background (same as landing page)

      // Fill invertocat with the user's tartan
      fillInvertocatWithSett(sett);

      // Update share links
      updateShareLinks(username);

      // Update page title for SEO and bookmarking
      document.title = clanMatch
        ? `${clanMatch.displayName} Clan Tartan â€” Dev Tartan`
        : `${username}'s Developer Tartan â€” Dev Tartan`;

      // Reset button state
      genBtn.textContent = origBtnText;
      genBtn.disabled = false;

      // Scroll tartan into view on mobile
      document.querySelector('.tartan-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Update social share links
    function updateShareLinks(username) {
      const paletteSuffix = currentPalette !== 'traditional' ? `&palette=${encodeURIComponent(currentPalette)}` : '';
      const url = `https://leereilly.net/dev-tartan?username=${encodeURIComponent(username)}${paletteSuffix}`;
      const text = `ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ I found my developer clan tartan! Every GitHub username generates a unique, deterministic plaid. What's yours? #DevTartan #GitHub`;
      const encodedText = encodeURIComponent(`${text} ${url}`);
      const encodedUrl = encodeURIComponent(url);

      document.getElementById('share-x').href =
        `https://x.com/intent/tweet?text=${encodedText}`;
      document.getElementById('share-bluesky').href =
        `https://bsky.app/intent/compose?text=${encodedText}`;
      document.getElementById('share-linkedin').href =
        `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;
      document.getElementById('share-threads').href =
        `https://threads.net/intent/post?text=${encodedText}`;

      const copyLink = document.getElementById('share-copy');
      copyLink.onclick = function(e) {
        e.preventDefault();
        navigator.clipboard.writeText(url).then(() => {
          gtag('event', 'copy_link', { username: username });
          const orig = copyLink.textContent;
          copyLink.textContent = 'âœ… Copied!';
          setTimeout(() => { copyLink.textContent = orig; }, 2000);
        });
      };

      document.getElementById('share-links').style.display = 'flex';
    }

    // Set the page background to a faded repeating tartan tile
    function setTartanBackground(sett) {
      const tileSize = 160;
      const symmetricSett = expandSett(sett);
      const repeatWidth = symmetricSett.reduce((sum, s) => sum + s.width, 0);
      if (repeatWidth === 0) return;
      const scale = tileSize / repeatWidth;

      let svgParts = [];
      svgParts.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${tileSize}" height="${tileSize}">`);
      // Dark base so the washed-out pattern stays near the body background
      svgParts.push(`<rect width="${tileSize}" height="${tileSize}" fill="#f4edd3"/>`);

      // Warp (vertical stripes) at very low opacity
      svgParts.push(`<g opacity="0.08">`);
      let x = 0;
      for (const stripe of symmetricSett) {
        const w = stripe.width * scale;
        svgParts.push(`<rect x="${x}" y="0" width="${Math.ceil(w)}" height="${tileSize}" fill="${stripe.color.hex}"/>`);
        x += w;
      }
      svgParts.push(`</g>`);

      // Weft (horizontal stripes) at very low opacity
      svgParts.push(`<g opacity="0.06">`);
      let y = 0;
      for (const stripe of symmetricSett) {
        const h = stripe.width * scale;
        svgParts.push(`<rect x="0" y="${y}" width="${tileSize}" height="${Math.ceil(h)}" fill="${stripe.color.hex}"/>`);
        y += h;
      }
      svgParts.push(`</g>`);

      svgParts.push(`</svg>`);

      const svgDataUri = 'data:image/svg+xml,' + encodeURIComponent(svgParts.join(''));
      document.body.style.backgroundImage = `url("${svgDataUri}")`;
      document.body.style.backgroundRepeat = 'repeat';
      document.body.style.backgroundSize = `${tileSize}px ${tileSize}px`;
    }

    // â”€â”€ Bagpipe Audio Engine (Web Audio API) â”€â”€
    // Realistic Great Highland Bagpipe synthesis using additive harmonics,
    // breath noise, legato chanter, grace notes, and rich multi-harmonic drones.

    let bagpipeCtx = null;
    let bagpipePlaying = false;
    let bagpipeStopTimer = null;

    // GHB chanter scale (A=480Hz concert pitch, bagpipe tuning ~475-480Hz)
    // Low A to High A with sharped 7th (characteristic mixolydian)
    const BAGPIPE_SCALE = [
      480.00 * 0.5,    // Low G
      480.00 * 9/16,   // Low A
      480.00 * 5/8,    // B
      480.00 * 3/4,    // C (actually C#-ish in bagpipe temperament)
      480.00 * 3/4 * 1.04, // D
      480.00 * 7/8,    // E
      480.00 * 15/16,  // F (actually F#-ish)
      480.00,          // High G
      480.00 * 9/8,    // High A
    ];

    // Drone frequencies â€” Bb-based, with authentic bagpipe tuning
    const BASS_DRONE_FREQ = 120.0;    // Bass drone ~Bb2
    const TENOR_DRONE_FREQ = 240.0;   // Tenor drones ~Bb3

    // Build a PeriodicWave for reed-like timbre (chanter)
    // Strong odd harmonics + weaker even harmonics = nasal/reedy
    function chanterWave(ctx) {
      const n = 24;
      const real = new Float32Array(n);
      const imag = new Float32Array(n);
      real[0] = 0;
      imag[0] = 0;
      for (let h = 1; h < n; h++) {
        // Strong fundamental + odd harmonics, rolled-off even harmonics
        const isOdd = h % 2 === 1;
        const amp = (isOdd ? 1.0 : 0.3) / Math.pow(h, 0.75);
        // Slight formant bump around 3rd-5th harmonic for nasal quality
        const formant = (h >= 3 && h <= 6) ? 1.6 : 1.0;
        imag[h] = amp * formant;
      }
      return ctx.createPeriodicWave(real, imag, { disableNormalization: false });
    }

    // Build a PeriodicWave for drone â€” rich, buzzy, warm
    function droneWave(ctx) {
      const n = 32;
      const real = new Float32Array(n);
      const imag = new Float32Array(n);
      real[0] = 0;
      imag[0] = 0;
      for (let h = 1; h < n; h++) {
        // All harmonics present, rolling off like a sawtooth but warmer
        imag[h] = 1.0 / Math.pow(h, 0.9);
      }
      return ctx.createPeriodicWave(real, imag, { disableNormalization: false });
    }

    // Create filtered breath noise (constant, air-through-bag character)
    function createBreathNoise(ctx, destination, gain) {
      const bufferSize = ctx.sampleRate * 2;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = (Math.random() * 2 - 1);
      }
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;
      noise.loop = true;

      // Shape noise: bandpass to sound like air through a reed
      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass';
      bp.frequency.value = 1200;
      bp.Q.value = 0.8;

      // Second filter for high-frequency hiss
      const hp = ctx.createBiquadFilter();
      hp.type = 'highpass';
      hp.frequency.value = 2500;

      const noiseGain = ctx.createGain();
      noiseGain.gain.value = gain;

      noise.connect(bp);
      bp.connect(noiseGain);

      // Also route a quieter high hiss
      const hissGain = ctx.createGain();
      hissGain.gain.value = gain * 0.3;
      noise.connect(hp);
      hp.connect(hissGain);
      hissGain.connect(destination);

      noiseGain.connect(destination);
      noise.start();
      return { source: noise, gain: noiseGain, hissGain };
    }

    // Create a single drone pipe with multiple detuned oscillators
    function createDronePipe(ctx, freq, destination, gain, wave) {
      const oscs = [];
      // Three slightly detuned oscillators for chorus/beating
      const detunes = [0, -4, +5]; // cents
      const subGain = ctx.createGain();
      subGain.gain.value = gain;

      for (const det of detunes) {
        const osc = ctx.createOscillator();
        osc.setPeriodicWave(wave);
        osc.frequency.value = freq;
        osc.detune.value = det;
        osc.connect(subGain);
        osc.start();
        oscs.push(osc);
      }

      // Resonant low-pass to warm the drone
      const lp = ctx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.value = freq * 6;
      lp.Q.value = 0.7;

      subGain.connect(lp);
      lp.connect(destination);

      return { oscillators: oscs, gain: subGain, filter: lp };
    }

    // Schedule a single chanter note (additive synthesis with the reed wave)
    function scheduleNote(ctx, freq, startTime, duration, destination, wave, vol) {
      // Main chanter oscillator
      const osc1 = ctx.createOscillator();
      osc1.setPeriodicWave(wave);
      osc1.frequency.value = freq;

      // Second oscillator slightly detuned for thickness
      const osc2 = ctx.createOscillator();
      osc2.setPeriodicWave(wave);
      osc2.frequency.value = freq;
      osc2.detune.value = 3; // 3 cents sharp

      // Slow vibrato via LFO (bagpipes have subtle pitch waver from bag pressure)
      const vibrato = ctx.createOscillator();
      vibrato.frequency.value = 4.5; // ~4-5 Hz
      const vibratoGain = ctx.createGain();
      vibratoGain.gain.value = 2.5; // subtle pitch bend in cents
      vibrato.connect(vibratoGain);
      vibratoGain.connect(osc1.detune);
      vibratoGain.connect(osc2.detune);
      vibrato.start(startTime);
      vibrato.stop(startTime + duration + 0.05);

      // Formant filter chain â€” nasal resonance
      const formant1 = ctx.createBiquadFilter();
      formant1.type = 'peaking';
      formant1.frequency.value = freq * 3;
      formant1.gain.value = 6;
      formant1.Q.value = 2;

      const formant2 = ctx.createBiquadFilter();
      formant2.type = 'peaking';
      formant2.frequency.value = freq * 5;
      formant2.gain.value = 3;
      formant2.Q.value = 3;

      // Roll off very high frequencies
      const lp = ctx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.value = 4500;
      lp.Q.value = 0.5;

      const noteGain = ctx.createGain();
      // Legato â€” no silence between notes, just quick transitions
      noteGain.gain.setValueAtTime(0.001, startTime);
      noteGain.gain.exponentialRampToValueAtTime(vol, startTime + 0.008);
      noteGain.gain.setValueAtTime(vol, startTime + duration - 0.008);
      noteGain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

      osc1.connect(formant1);
      osc2.connect(formant1);
      formant1.connect(formant2);
      formant2.connect(lp);
      lp.connect(noteGain);
      noteGain.connect(destination);

      osc1.start(startTime);
      osc1.stop(startTime + duration + 0.01);
      osc2.start(startTime);
      osc2.stop(startTime + duration + 0.01);
    }

    // Schedule a very short grace note (embellishment) â€” characteristic of piping
    function scheduleGraceNote(ctx, freq, startTime, destination, wave) {
      const dur = 0.035;
      const osc = ctx.createOscillator();
      osc.setPeriodicWave(wave);
      osc.frequency.value = freq;

      const gn = ctx.createGain();
      gn.gain.setValueAtTime(0.001, startTime);
      gn.gain.exponentialRampToValueAtTime(0.10, startTime + 0.005);
      gn.gain.exponentialRampToValueAtTime(0.001, startTime + dur);

      const lp = ctx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.value = 4000;

      osc.connect(lp);
      lp.connect(gn);
      gn.connect(destination);

      osc.start(startTime);
      osc.stop(startTime + dur + 0.01);
      return dur;
    }

    // Derive a melody from hash bytes
    function deriveMelody(hashBytes) {
      const notes = [];
      const numNotes = 20 + (hashBytes[20] % 12); // 20-31 notes

      for (let i = 0; i < numNotes; i++) {
        const byte = hashBytes[(i + 16) % 32];
        const noteIndex = byte % BAGPIPE_SCALE.length;

        const durByte = hashBytes[(i + 17) % 32];
        let duration;
        if (durByte < 60) duration = 0.18;        // short
        else if (durByte < 140) duration = 0.32;   // quaver
        else if (durByte < 210) duration = 0.48;   // crotchet
        else duration = 0.7;                        // minim

        // Determine if a grace note precedes this note (very common in piping)
        const graceFlag = hashBytes[(i + 3) % 32];
        const hasGrace = graceFlag > 80; // ~70% of notes get grace notes
        // Grace note pitch: high A or high G (common embellishments)
        const graceNoteIndex = (graceFlag % 2 === 0) ? 8 : 7; // High A or High G

        notes.push({ noteIndex, duration, hasGrace, graceNoteIndex });
      }
      return notes;
    }

    // Simple delay-based reverb for room ambience
    function createReverb(ctx, destination) {
      const delays = [0.03, 0.07, 0.11, 0.17];
      const gains = [0.15, 0.10, 0.07, 0.04];
      const input = ctx.createGain();
      input.gain.value = 1.0;

      // Dry path
      input.connect(destination);

      // Wet paths (multiple delays)
      for (let i = 0; i < delays.length; i++) {
        const delay = ctx.createDelay(0.3);
        delay.delayTime.value = delays[i];
        const g = ctx.createGain();
        g.gain.value = gains[i];
        const lp = ctx.createBiquadFilter();
        lp.type = 'lowpass';
        lp.frequency.value = 2000 - i * 300;
        input.connect(delay);
        delay.connect(lp);
        lp.connect(g);
        g.connect(destination);
      }
      return input;
    }

    async function playBagpipes(username) {
      if (bagpipePlaying) {
        stopBagpipes();
        return;
      }

      const hashBytes = await sha256(username.toLowerCase());
      const melody = deriveMelody(hashBytes);

      bagpipeCtx = new (window.AudioContext || window.webkitAudioContext)();
      bagpipePlaying = true;

      const btn = document.getElementById('bagpipe-btn');
      btn.textContent = 'â¹ Stop Bagpipes';
      btn.classList.add('playing');

      const ctx = bagpipeCtx;

      // Master chain: reverb â†’ compressor â†’ destination
      const compressor = ctx.createDynamicsCompressor();
      compressor.threshold.value = -18;
      compressor.knee.value = 6;
      compressor.ratio.value = 6;
      compressor.attack.value = 0.003;
      compressor.release.value = 0.15;
      compressor.connect(ctx.destination);

      const reverb = createReverb(ctx, compressor);

      const master = ctx.createGain();
      master.gain.value = 0.55;
      master.connect(reverb);

      // Build waveforms
      const cWave = chanterWave(ctx);
      const dWave = droneWave(ctx);

      // â”€â”€ Drones â”€â”€
      const bassDrone = createDronePipe(ctx, BASS_DRONE_FREQ, master, 0.07, dWave);
      const tenorDrone1 = createDronePipe(ctx, TENOR_DRONE_FREQ, master, 0.055, dWave);
      const tenorDrone2 = createDronePipe(ctx, TENOR_DRONE_FREQ * 1.001, master, 0.055, dWave);

      // â”€â”€ Breath noise â”€â”€
      const breathNoise = createBreathNoise(ctx, master, 0.012);

      // Fade everything in over 1.5s (bag filling up, drones starting)
      const allDrones = [bassDrone, tenorDrone1, tenorDrone2];
      allDrones.forEach(d => {
        const target = d.gain.gain.value;
        d.gain.gain.setValueAtTime(0, ctx.currentTime);
        d.gain.gain.linearRampToValueAtTime(target * 0.3, ctx.currentTime + 0.4);
        d.gain.gain.linearRampToValueAtTime(target, ctx.currentTime + 1.5);
      });
      breathNoise.gain.gain.setValueAtTime(0, ctx.currentTime);
      breathNoise.gain.gain.linearRampToValueAtTime(0.012, ctx.currentTime + 1.0);

      // â”€â”€ Schedule chanter melody â”€â”€
      let time = ctx.currentTime + 1.8; // drones settle first

      for (let i = 0; i < melody.length; i++) {
        const note = melody[i];
        const freq = BAGPIPE_SCALE[note.noteIndex];

        // Grace note embellishment
        if (note.hasGrace && i > 0) {
          const graceFreq = BAGPIPE_SCALE[note.graceNoteIndex];
          const graceDur = scheduleGraceNote(ctx, graceFreq, time, master, cWave);
          time += graceDur;
        }

        // Main note â€” legato, no gap
        scheduleNote(ctx, freq, time, note.duration, master, cWave, 0.14);
        time += note.duration;
      }

      // Fade drones out after melody
      const fadeStart = time + 0.3;
      const endTime = fadeStart + 1.5;
      allDrones.forEach(d => {
        d.gain.gain.setValueAtTime(d.gain.gain.value, fadeStart);
        d.gain.gain.linearRampToValueAtTime(0, endTime);
        d.oscillators.forEach(o => o.stop(endTime + 0.1));
      });
      breathNoise.gain.gain.setValueAtTime(0.012, fadeStart);
      breathNoise.gain.gain.linearRampToValueAtTime(0, endTime);
      breathNoise.source.stop(endTime + 0.1);

      // Auto-stop
      const totalMs = (endTime - ctx.currentTime + 0.3) * 1000;
      bagpipeStopTimer = setTimeout(() => {
        if (bagpipePlaying) stopBagpipes();
      }, totalMs);
    }

    function stopBagpipes() {
      bagpipePlaying = false;
      if (bagpipeStopTimer) { clearTimeout(bagpipeStopTimer); bagpipeStopTimer = null; }
      const btn = document.getElementById('bagpipe-btn');
      btn.textContent = 'ğŸµ Play Bagpipes';
      btn.classList.remove('playing');

      if (bagpipeCtx) {
        bagpipeCtx.close().catch(() => {});
        bagpipeCtx = null;
      }
    }

    // Render bagpipe tune offline and download as WAV
    async function downloadBagpipes(username) {
      const btn = document.getElementById('download-bagpipe-btn');
      const origText = btn.textContent;
      btn.textContent = 'â³ Renderingâ€¦';
      btn.disabled = true;

      try {
        const hashBytes = await sha256(username.toLowerCase());
        const melody = deriveMelody(hashBytes);

        // Calculate total duration
        let melodyDur = 1.8; // drone settle time
        for (const note of melody) {
          if (note.hasGrace) melodyDur += 0.035;
          melodyDur += note.duration;
        }
        const totalDur = melodyDur + 2.0; // fade out + padding

        const sampleRate = 44100;
        const ctx = new OfflineAudioContext(2, Math.ceil(totalDur * sampleRate), sampleRate);

        // Master chain: reverb â†’ compressor â†’ destination
        const compressor = ctx.createDynamicsCompressor();
        compressor.threshold.value = -18;
        compressor.knee.value = 6;
        compressor.ratio.value = 6;
        compressor.attack.value = 0.003;
        compressor.release.value = 0.15;
        compressor.connect(ctx.destination);

        const reverb = createReverb(ctx, compressor);

        const master = ctx.createGain();
        master.gain.value = 0.55;
        master.connect(reverb);

        const cWave = chanterWave(ctx);
        const dWave = droneWave(ctx);

        // Drones
        const bassDrone = createDronePipe(ctx, BASS_DRONE_FREQ, master, 0.07, dWave);
        const tenorDrone1 = createDronePipe(ctx, TENOR_DRONE_FREQ, master, 0.055, dWave);
        const tenorDrone2 = createDronePipe(ctx, TENOR_DRONE_FREQ * 1.001, master, 0.055, dWave);

        // Breath noise
        const breathNoise = createBreathNoise(ctx, master, 0.012);

        // Fade in
        const allDrones = [bassDrone, tenorDrone1, tenorDrone2];
        allDrones.forEach(d => {
          const target = d.gain.gain.value;
          d.gain.gain.setValueAtTime(0, 0);
          d.gain.gain.linearRampToValueAtTime(target * 0.3, 0.4);
          d.gain.gain.linearRampToValueAtTime(target, 1.5);
        });
        breathNoise.gain.gain.setValueAtTime(0, 0);
        breathNoise.gain.gain.linearRampToValueAtTime(0.012, 1.0);

        // Schedule melody
        let time = 1.8;
        for (let i = 0; i < melody.length; i++) {
          const note = melody[i];
          const freq = BAGPIPE_SCALE[note.noteIndex];
          if (note.hasGrace && i > 0) {
            const graceFreq = BAGPIPE_SCALE[note.graceNoteIndex];
            const graceDur = scheduleGraceNote(ctx, graceFreq, time, master, cWave);
            time += graceDur;
          }
          scheduleNote(ctx, freq, time, note.duration, master, cWave, 0.14);
          time += note.duration;
        }

        // Fade out
        const fadeStart = time + 0.3;
        const endTime = fadeStart + 1.5;
        allDrones.forEach(d => {
          d.gain.gain.setValueAtTime(d.gain.gain.value, fadeStart);
          d.gain.gain.linearRampToValueAtTime(0, endTime);
          d.oscillators.forEach(o => o.stop(endTime + 0.1));
        });
        breathNoise.gain.gain.setValueAtTime(0.012, fadeStart);
        breathNoise.gain.gain.linearRampToValueAtTime(0, endTime);
        breathNoise.source.stop(endTime + 0.1);

        // Render to buffer
        const rendered = await ctx.startRendering();

        // Encode as WAV
        const wavBlob = audioBufferToWav(rendered);
        const url = URL.createObjectURL(wavBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${username}-bagpipe.wav`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } finally {
        btn.textContent = origText;
        btn.disabled = false;
      }
    }

    // Convert an AudioBuffer to a WAV Blob
    function audioBufferToWav(buffer) {
      const numChannels = buffer.numberOfChannels;
      const sampleRate = buffer.sampleRate;
      const format = 1; // PCM
      const bitsPerSample = 16;
      const channels = [];
      for (let c = 0; c < numChannels; c++) {
        channels.push(buffer.getChannelData(c));
      }
      const numFrames = buffer.length;
      const bytesPerSample = bitsPerSample / 8;
      const blockAlign = numChannels * bytesPerSample;
      const dataSize = numFrames * blockAlign;
      const headerSize = 44;
      const arrayBuffer = new ArrayBuffer(headerSize + dataSize);
      const view = new DataView(arrayBuffer);

      // WAV header
      writeString(view, 0, 'RIFF');
      view.setUint32(4, headerSize - 8 + dataSize, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true); // subchunk1 size
      view.setUint16(20, format, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * blockAlign, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitsPerSample, true);
      writeString(view, 36, 'data');
      view.setUint32(40, dataSize, true);

      // Interleave and write samples
      let offset = headerSize;
      for (let i = 0; i < numFrames; i++) {
        for (let c = 0; c < numChannels; c++) {
          let sample = channels[c][i];
          sample = Math.max(-1, Math.min(1, sample));
          sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
          view.setInt16(offset, sample | 0, true);
          offset += 2;
        }
      }

      return new Blob([arrayBuffer], { type: 'audio/wav' });

      function writeString(view, offset, str) {
        for (let i = 0; i < str.length; i++) {
          view.setUint8(offset + i, str.charCodeAt(i));
        }
      }
    }

    // Event listeners
    document.getElementById('tartan-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('username');
      const username = input.value.trim().replace(/^@/, '');
      const errorEl = document.getElementById('input-error');
      if (!username) {
        errorEl.style.display = 'block';
        input.focus();
        return;
      }
      errorEl.style.display = 'none';
      const url = new URL(window.location);
      url.searchParams.set('username', username);
      if (currentPalette !== 'traditional') {
        url.searchParams.set('palette', currentPalette);
      } else {
        url.searchParams.delete('palette');
      }
      url.hash = '';
      window.history.pushState({ username, palette: currentPalette }, '', url);
      gtag('event', 'generate_tartan', { username: username, palette: currentPalette });
      generateTartan(username);
      document.getElementById('gallery-section').classList.add('hidden');
    });

    // Back/forward navigation
    window.addEventListener('popstate', (e) => {
      const params = new URLSearchParams(window.location.search);
      const username = (params.get('username') || '').trim().replace(/^@/, '');
      if (username) {
        const palette = (params.get('palette') || 'traditional').toLowerCase();
        if (PALETTES[palette]) {
          currentPalette = palette;
          TARTAN_PALETTE = PALETTES[palette];
          document.getElementById('palette-' + palette).checked = true;
        }
        document.getElementById('username').value = username;
        generateTartan(username);
        document.getElementById('gallery-section').classList.add('hidden');
      } else {
        resetToHome();
      }
    });

    // Hide error on input
    document.getElementById('username').addEventListener('input', () => {
      document.getElementById('input-error').style.display = 'none';
    });


    // Logo click: reset to home / gallery view
    document.getElementById('logo-link').addEventListener('click', (e) => {
      e.preventDefault();
      resetToHome();
    });

    document.getElementById('invertocat-link').addEventListener('click', (e) => {
      e.preventDefault();
      resetToHome();
    });

    function resetToHome() {
      // Clear generated tartan state
      document.getElementById('tartan-display').style.display = 'none';
      document.getElementById('secondary-actions').style.display = 'none';
      document.getElementById('username-label').style.display = 'none';
      document.getElementById('sett-display').style.display = 'none';
      document.getElementById('character-container').style.display = 'none';
      document.getElementById('share-links').style.display = 'none';
      document.getElementById('username').value = '';
      // Show gallery again
      document.getElementById('gallery-section').classList.remove('hidden');
      // Reset URL
      const url = new URL(window.location);
      url.searchParams.delete('username');
      url.hash = '';
      window.history.replaceState({}, '', url);
      // Reset page title
      document.title = 'Dev Tartan â€” Generate a Unique Tartan from Your GitHub Username';
      // Re-randomize invertocat tartan
      fillInvertocatRandom();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('download-btn').addEventListener('click', () => {
      const username = document.getElementById('username').value.trim().replace(/^@/, '');
      gtag('event', 'download_svg', { username: username, palette: currentPalette });
      downloadSVG();
    });

    document.getElementById('bagpipe-btn').addEventListener('click', () => {
      const username = document.getElementById('username').value.trim().replace(/^@/, '');
      if (username) {
        gtag('event', 'play_bagpipes', { username: username });
        playBagpipes(username);
      }
    });

    document.getElementById('download-bagpipe-btn').addEventListener('click', () => {
      const username = document.getElementById('username').value.trim().replace(/^@/, '');
      if (username) {
        gtag('event', 'download_tune', { username: username });
        downloadBagpipes(username);
      }
    });

    // Palette toggle
    document.querySelectorAll('input[name="palette"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentPalette = e.target.value;
        TARTAN_PALETTE = PALETTES[currentPalette];
        gtag('event', 'select_palette', { palette: currentPalette });
        const url = new URL(window.location);
        if (currentPalette !== 'traditional') {
          url.searchParams.set('palette', currentPalette);
        } else {
          url.searchParams.delete('palette');
        }
        window.history.replaceState({}, '', url);
        const username = document.getElementById('username').value.trim().replace(/^@/, '');
        if (username) generateTartan(username);
      });
    });

    // â”€â”€ Gallery: show tartans of recently-active GitHub users â”€â”€â”€â”€
    async function renderGalleryTile(username, avatarUrl, container) {
      const ns = 'http://www.w3.org/2000/svg';
      const tileSize = 200; // rendered size, CSS scales to fit

      const hashBytes = await sha256(username.toLowerCase());
      const sett = deriveSett(hashBytes);
      const symmetricSett = expandSett(sett);
      const repeatWidth = symmetricSett.reduce((sum, s) => sum + s.width, 0);
      if (repeatWidth === 0) return;
      const scale = tileSize / (repeatWidth * 3);

      // Build a lightweight SVG string (faster than DOM for many tiles)
      let parts = [];
      parts.push(`<svg xmlns="${ns}" width="${tileSize}" height="${tileSize}" viewBox="0 0 ${tileSize} ${tileSize}">`);
      parts.push(`<rect width="${tileSize}" height="${tileSize}" fill="${sett[0].color.hex}"/>`);

      // Warp
      parts.push(`<g opacity="0.9">`);
      let x = 0;
      while (x < tileSize) {
        for (const stripe of symmetricSett) {
          const w = stripe.width * scale;
          parts.push(`<rect x="${x}" y="0" width="${Math.ceil(w)}" height="${tileSize}" fill="${stripe.color.hex}"/>`);
          x += w;
          if (x > tileSize) break;
        }
      }
      parts.push(`</g>`);

      // Weft
      parts.push(`<g opacity="0.55" style="mix-blend-mode:multiply">`);
      let y = 0;
      while (y < tileSize) {
        for (const stripe of symmetricSett) {
          const h = stripe.width * scale;
          parts.push(`<rect x="0" y="${y}" width="${tileSize}" height="${Math.ceil(h)}" fill="${stripe.color.hex}"/>`);
          y += h;
          if (y > tileSize) break;
        }
      }
      parts.push(`</g>`);
      parts.push(`</svg>`);

      const card = document.createElement('div');
      card.className = 'gallery-card';
      card.setAttribute('role', 'button');
      card.setAttribute('tabindex', '0');
      card.setAttribute('aria-label', `View tartan for ${username}`);
      card.innerHTML = parts.join('') +
        `<div class="card-info">` +
        `<img class="card-avatar" src="${avatarUrl}&s=44" alt="${username}'s avatar" loading="lazy" onerror="this.style.display='none'">` +
        `<span class="card-username">${username}</span>` +
        `</div>`;

      // Click to generate full tartan
      const activate = () => {
        document.getElementById('username').value = username;
        generateTartan(username);
        document.getElementById('gallery-section').classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      card.addEventListener('click', activate);
      card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activate(); } });

      // Staggered fade-in
      card.style.opacity = '0';
      card.style.transform = 'translateY(12px)';
      card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
      container.appendChild(card);
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        });
      });
    }

    async function loadGallery() {
      const grid = document.getElementById('gallery-grid');
      const loading = document.getElementById('gallery-loading');

      try {
        const res = await fetch('https://api.github.com/events?per_page=100');
        if (!res.ok) throw new Error('API returned ' + res.status);
        const events = await res.json();

        // Extract unique users (username + avatar), shuffle, take 24
        const seen = new Set();
        const users = [];
        for (const evt of events) {
          const login = evt.actor && evt.actor.login;
          const avatar = evt.actor && evt.actor.avatar_url;
          if (login && avatar && !seen.has(login) && !login.includes('[bot]') && !login.endsWith('-bot') && !login.includes('bot[')) {
            seen.add(login);
            users.push({ login, avatar });
          }
        }

        // Fisher-Yates shuffle
        for (let i = users.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [users[i], users[j]] = [users[j], users[i]];
        }

        const selected = users.slice(0, 24);

        if (selected.length === 0) {
          loading.innerHTML = '<em>No active users found â€” try refreshing.</em>';
          return;
        }

        loading.remove();

        // Render tiles with a small stagger
        for (let i = 0; i < selected.length; i++) {
          const u = selected[i];
          // Slight stagger delay for visual effect
          setTimeout(() => renderGalleryTile(u.login, u.avatar, grid), i * 60);
        }
      } catch (err) {
        console.warn('Gallery fetch failed:', err);
        loading.innerHTML = '<em>Could not fetch recent users â€” the GitHub API may be resting.</em>';
      }
    }

    // Load gallery on page start (don't block main thread)
    requestAnimationFrame(() => loadGallery());

    // Generate from ?username= and ?palette= query parameters or #hash on page load
    (function autoGenerate() {
      const params = new URLSearchParams(window.location.search);
      const paletteParam = (params.get('palette') || '').trim().toLowerCase();
      if (paletteParam && PALETTES[paletteParam]) {
        currentPalette = paletteParam;
        TARTAN_PALETTE = PALETTES[currentPalette];
        document.getElementById('palette-' + currentPalette).checked = true;
      }
      const fromQuery = (params.get('username') || '').trim().replace(/^@/, '');
      const fromHash = window.location.hash
        ? decodeURIComponent(window.location.hash.slice(1)).replace(/^@/, '')
        : '';
      const username = fromQuery || fromHash;
      if (username) {
        document.getElementById('username').value = username;
        generateTartan(username);
        document.getElementById('gallery-section').classList.add('hidden');
      }
    })();

    // â”€â”€ Console Easter Eggs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function devConsoleEasterEggs() {
      // Styled ASCII art banner in the console
      console.log(
        '%c' +
        'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n' +
        'â•‘           ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿  DEV TARTAN  ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿              â•‘\n' +
        'â•‘  Every developer deserves their own clan.    â•‘\n' +
        'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        'color: #c41e3a; font-family: monospace; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 0 #1a472a;'
      );

      // Fun dev messages
      console.log(
        '%cğŸ§¶ Weaving secrets into the console since 2025...',
        'color: #8b774b; font-style: italic; font-size: 12px;'
      );
      console.log(
        '%cğŸ’¡ Try: %cdevTartan.loom()%c or %cdevTartan.fortune()%c in this console',
        'color: #6b5240; font-size: 12px;',
        'color: #8b2500; font-weight: bold; font-size: 12px;',
        'color: #6b5240; font-size: 12px;',
        'color: #8b2500; font-weight: bold; font-size: 12px;',
        'color: #6b5240; font-size: 12px;'
      );
      // Secret global object with fun console functions
      window.devTartan = {
        loom: function() {
          const frames = [
            '  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  ',
            '  â”‚ â•‘â•‘â•‘â•‘â•‘â•‘â•‘ â”‚  ',
            '  â”‚ â•â•â•â•â•â•â• â”‚  ',
            '  â”‚ â•‘â•‘â•‘â•‘â•‘â•‘â•‘ â”‚  ',
            '  â”‚ â•â•â•â•â•â•â• â”‚  ',
            '  â”‚ â•‘â•‘â•‘â•‘â•‘â•‘â•‘ â”‚  ',
            '  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  ',
            '    ğŸ§µğŸ§µğŸ§µğŸ§µ    ',
          ];
          console.log('%c' + frames.join('\n'), 'color: #8b2500; font-family: monospace; font-size: 14px;');
          console.log('%c*clack clack clack* ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿', 'color: #1a472a; font-style: italic;');
          return 'ğŸ§¶ The loom weaves on...';
        },

        fortune: function() {
          const fortunes = [
            'ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ A Scotsman never reveals his thread count.',
            'ğŸ§¶ Your pull request will be merged... when the Highland cows come home.',
            'âš”ï¸  In the battle of tabs vs spaces, tartan uses both.',
            'ğŸµ Your code review feedback sounds like bagpipes â€” loud and unsettling.',
            'ğŸ¥ƒ "Any sufficiently advanced tartan is indistinguishable from plaid." â€” Arthur C. Clarke, probably.',
            'ğŸ‘ A sheep somewhere is judging your CSS.',
            'ğŸ’€ git push --force is the digital equivalent of wearing another clan\'s tartan.',
            'ğŸ”ï¸  Your test coverage is like a Highland winter â€” sparse and unforgiving.',
            'ğŸ”® The hash foretells: your next deploy will be on a Friday.',
            'ğŸ“œ Ancient Scottish proverb: "He who refactors on main branch courts disaster."',
            'ğŸ¦„ There are more possible Dev Tartans than atoms in the universe. Yours is still ugly though.',
            'ğŸªµ Logging is the tartan of debugging â€” warp and weft of stdout and stderr.',
          ];
          const pick = fortunes[Math.floor(Math.random() * fortunes.length)];
          console.log('%c' + pick, 'color: #5b2c6f; font-size: 13px; font-style: italic;');
          return pick;
        },

        hierarchyOfNeeds: function() {
          console.log('%c' +
            '         â•±â•²                                 \n' +
            '        â•±  â•²    Self-actualization           \n' +
            '       â•± ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ â•²   (Your own tartan)            \n' +
            '      â•±â”€â”€â”€â”€â”€â”€â•²                              \n' +
            '     â•±  Esteem â•²  (GitHub stars)             \n' +
            '    â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                           \n' +
            '   â•±  Belonging   â•² (Merged PRs)            \n' +
            '  â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                        \n' +
            ' â•±    Safety        â•² (git stash)           \n' +
            'â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                      \n' +
            'â•± Physiological needs  â•² (WiFi & coffee)    \n' +
            'â•±â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•²                  ',
            'color: #2b4c7e; font-family: monospace; font-size: 12px;'
          );
          return 'ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ Maslow would be proud.';
        },

        whoami: function() {
          const username = document.getElementById('username').value.trim();
          if (!username) {
            console.log('%cğŸ¤· Generate a tartan first, then ask again.', 'color: #c41e3a;');
            return;
          }
          console.log('%c' +
            'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n' +
            'â”‚  CLAN REGISTRY                   â”‚\n' +
            'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n' +
            'â”‚  Developer: ' + username.padEnd(20) + ' â”‚\n' +
            'â”‚  Clan:      dev-' + username.slice(0,14).padEnd(16) + ' â”‚\n' +
            'â”‚  Motto:     "It works on my     â”‚\n' +
            'â”‚              machine"            â”‚\n' +
            'â”‚  Seat:      localhost:3000       â”‚\n' +
            'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜',
            'color: #1a472a; font-family: monospace; font-size: 13px;'
          );
          return 'âš”ï¸  Clan ' + username + ' recognized.';
        },

        tartan: function() {
          if (!_lastSett) {
            console.log('%cğŸ¤· Generate a tartan first, then call devTartan.tartan()', 'color: #c41e3a;');
            return;
          }
          // Draw tartan on an off-screen canvas
          var size = 128;
          var canvas = document.createElement('canvas');
          canvas.width = size; canvas.height = size;
          var ctx = canvas.getContext('2d');
          var sym = expandSett(_lastSett);
          var rw = sym.reduce(function(s, t) { return s + t.width; }, 0);
          if (!rw) return;
          var sc = size / (rw * 3);

          // Warp (vertical)
          var x = 0;
          while (x < size) {
            for (var i = 0; i < sym.length && x < size; i++) {
              var w = Math.ceil(sym[i].width * sc);
              ctx.fillStyle = sym[i].color.hex;
              ctx.fillRect(x, 0, w, size);
              x += w;
            }
          }
          // Weft (horizontal) with multiply-like blend
          ctx.globalAlpha = 0.55;
          ctx.globalCompositeOperation = 'multiply';
          var y = 0;
          while (y < size) {
            for (var j = 0; j < sym.length && y < size; j++) {
              var h = Math.ceil(sym[j].width * sc);
              ctx.fillStyle = sym[j].color.hex;
              ctx.fillRect(0, y, size, h);
              y += h;
            }
          }
          ctx.globalAlpha = 1;
          ctx.globalCompositeOperation = 'source-over';

          // Detect Safari (no background-image support in console)
          var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

          if (!isSafari) {
            // Chrome, Edge, Firefox â€” render via data URI background-image
            var dataUrl = canvas.toDataURL('image/png');
            console.log(
              '%c  ',
              'font-size: 1px;' +
              'padding: 64px 64px;' +
              'background-image: url(' + dataUrl + ');' +
              'background-size: cover;' +
              'background-repeat: no-repeat;'
            );
          } else {
            // Safari fallback â€” colored block characters
            var cols = 48, rows = 48;
            var imgData = ctx.getImageData(0, 0, size, size);
            for (var r = 0; r < rows; r++) {
              var parts = [], styles = [];
              var py = Math.floor(r * size / rows);
              for (var c = 0; c < cols; c++) {
                var px = Math.floor(c * size / cols);
                var idx = (py * size + px) * 4;
                var rgb = 'rgb(' + imgData.data[idx] + ',' + imgData.data[idx+1] + ',' + imgData.data[idx+2] + ')';
                parts.push('%c  ');
                styles.push('background:' + rgb + ';');
              }
              console.log.apply(console, [parts.join('')].concat(styles));
            }
          }
          var un = document.getElementById('username').value.trim();
          console.log('%cğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ ' + (un || 'Your') + ' tartan, rendered in the console.', 'color: #1a472a; font-style: italic; font-size: 12px;');
          return 'ğŸ§¶ Tartan rendered above â†‘';
        },

        help: function() {
          console.log('%cğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ Dev Tartan Console Commands:', 'color: #8b2500; font-weight: bold; font-size: 13px;');
          console.log('%c  devTartan.loom()              â€“ Watch the loom weave', 'color: #3d2b1f; font-family: monospace;');
          console.log('%c  devTartan.fortune()           â€“ Developer fortune cookie', 'color: #3d2b1f; font-family: monospace;');
          console.log('%c  devTartan.whoami()            â€“ Your clan registration', 'color: #3d2b1f; font-family: monospace;');
          console.log('%c  devTartan.hierarchyOfNeeds()  â€“ Maslow, but for devs', 'color: #3d2b1f; font-family: monospace;');
          console.log('%c  devTartan.tartan()            â€“ Render your tartan here', 'color: #3d2b1f; font-family: monospace;');
          console.log('%c  devTartan.help()              â€“ This help text', 'color: #3d2b1f; font-family: monospace;');
          return 'ğŸ“– Available commands listed above.';
        }
      };
    })();

    // â”€â”€ Invertocat random tartan fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fillInvertocatRandom() {
      const pat = document.getElementById('octocat-tartan');
      if (!pat) return;
      const palette = PALETTES.traditional;
      const size = 16;
      pat.setAttribute('width', size);
      pat.setAttribute('height', size);
      pat.innerHTML = '';

      // Pick 4â€“6 random colours
      const numColors = 4 + Math.floor(Math.random() * 3);
      const colors = [];
      while (colors.length < numColors) {
        const c = palette[Math.floor(Math.random() * palette.length)];
        if (!colors.find(x => x.hex === c.hex)) colors.push(c);
      }

      // Random stripe widths
      const stripes = colors.map(c => ({
        color: c.hex,
        width: 1 + Math.floor(Math.random() * 3)
      }));

      // Mirror the sett
      const mirror = stripes.length > 1
        ? [...stripes, ...stripes.slice(1, -1).reverse()]
        : stripes;

      const total = mirror.reduce((s, st) => s + st.width, 0);
      const scale = size / total;

      // Background
      const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bg.setAttribute('width', size);
      bg.setAttribute('height', size);
      bg.setAttribute('fill', colors[0].hex);
      pat.appendChild(bg);

      // Warp (vertical stripes)
      let x = 0;
      for (let rep = 0; rep < 3; rep++) {
        for (const st of mirror) {
          const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          r.setAttribute('x', x * scale);
          r.setAttribute('y', 0);
          r.setAttribute('width', st.width * scale);
          r.setAttribute('height', size);
          r.setAttribute('fill', st.color);
          r.setAttribute('opacity', '0.7');
          pat.appendChild(r);
          x += st.width;
        }
      }

      // Weft (horizontal stripes)
      let y = 0;
      for (let rep = 0; rep < 3; rep++) {
        for (const st of mirror) {
          const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          r.setAttribute('x', 0);
          r.setAttribute('y', y * scale);
          r.setAttribute('width', size);
          r.setAttribute('height', st.width * scale);
          r.setAttribute('fill', st.color);
          r.setAttribute('opacity', '0.5');
          pat.appendChild(r);
          y += st.width;
        }
      }
    }
    fillInvertocatRandom();

    // Fill the invertocat with a specific tartan sett (called after generation)
    function fillInvertocatWithSett(sett) {
      const pat = document.getElementById('octocat-tartan');
      if (!pat) return;
      const size = 16;
      pat.setAttribute('width', size);
      pat.setAttribute('height', size);
      pat.innerHTML = '';

      const mirror = expandSett(sett);
      const total = mirror.reduce((s, st) => s + st.width, 0);
      if (total === 0) return;
      const scale = size / total;

      const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bg.setAttribute('width', size);
      bg.setAttribute('height', size);
      bg.setAttribute('fill', sett[0].color.hex);
      pat.appendChild(bg);

      let x = 0;
      for (let rep = 0; rep < 3; rep++) {
        for (const st of mirror) {
          const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          r.setAttribute('x', x * scale); r.setAttribute('y', 0);
          r.setAttribute('width', st.width * scale); r.setAttribute('height', size);
          r.setAttribute('fill', st.color.hex); r.setAttribute('opacity', '0.7');
          pat.appendChild(r); x += st.width;
        }
      }

      let y = 0;
      for (let rep = 0; rep < 3; rep++) {
        for (const st of mirror) {
          const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          r.setAttribute('x', 0); r.setAttribute('y', y * scale);
          r.setAttribute('width', size); r.setAttribute('height', st.width * scale);
          r.setAttribute('fill', st.color.hex); r.setAttribute('opacity', '0.5');
          pat.appendChild(r); y += st.width;
        }
      }
    }
  </script>
  <!--
       _
      | |      "I see you scrolled all the way
      | |       to the bottom of the source.
      | |___    Here, have a haggis: ğŸ«“
      |_____|   You've earned it."

      No animals were harmed in the making
      of this tartan generator. Several
      SHA-256 hashes were, however,
      ruthlessly sliced into bytes.
  -->
  <script>
    // Theme toggle â€” default to light mode, persist choice in localStorage
    (function() {
      const toggle = document.getElementById('theme-toggle');
      const stored = localStorage.getItem('dev-tartan-theme');
      if (stored === 'dark') document.body.classList.add('dark-mode');
      toggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('dev-tartan-theme', isDark ? 'dark' : 'light');
      });
    })();
  </script>
</body>
</html>
